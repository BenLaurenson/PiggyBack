# PiggyBack Security Audit - Source of Truth

> Ralph Loop: Discovery-only. Minimum 10 iterations. No fixes.
> Started: 2026-02-26

## Status: SCANNING - Iteration 11 complete (11/20+). Second 10-iteration batch.

## Iteration Log
- **Iter 1**: 5 phases, ~152 raw findings, deduplicated to ~75 unique.
- **Iter 2**: 5 phases (x2 — prior session + current), ~120 raw findings across 10 agent runs. After dedup against iter 1 and cross-agent overlap: +7 HIGH, +25 MEDIUM, +18 LOW, +10 INFO = 60 new unique findings.
- **Iter 3**: 5 phases. Context window exhausted mid-consolidation. Recovered from summary + late Phase 1 completion: +1 HIGH, +15 MEDIUM, +9 LOW, +4 INFO = 29 new unique findings after dedup.
- **Iter 4**: 5 phases launched. Phases 2-5 hit API rate limit (zero results). Phase 1 completed: 18 raw findings, 9 genuinely new after dedup. +0 HIGH, +4 MEDIUM, +3 LOW, +2 INFO.
- **Iter 5**: 5 phases completed. ~93 raw findings across 5 agents. After dedup against 178 existing: +6 HIGH, +22 MEDIUM, +16 LOW, +5 INFO = 49 new unique findings. Key discoveries: SSRF via Up Bank pagination URLs (token leak), partnership dissolution attacks (orphaned data, locked-in partners, merge_partnerships bypass), merge_partnerships data loss (10+ tables not migrated), transaction_share_overrides text/uuid type mismatch with no FK, multiple race conditions, encryption key rotation destroys all tokens, comprehensive DB schema audit (missing CHECKs, FKs, indexes, RLS gaps).
- **Iter 6**: 5 phases completed. ~133 raw findings across 5 agents. After dedup against 227 existing: +0 HIGH, +19 MEDIUM, +12 LOW, +5 INFO = 36 new unique findings + 8 attack chains. Key discoveries: budget summary split divergence (M111), ticker symbol manipulation (M112), negative expenses as phantom income (M113), 9+ client-only pages relying solely on RLS (M114), dead DELETE endpoint for columns (M115), 8 multi-step attack chains including CRITICAL-severity "Cron-Powered Cross-User Data Injection" (AC4).
- **Iter 7**: 5 phases completed. ~83 raw findings across 5 agents. After dedup against 271 existing: +1 CRITICAL, +3 HIGH, +22 MEDIUM, +16 LOW, +3 INFO = 50 new unique findings (tied for highest yield). **CRITICAL DISCOVERY**: C3 — `partnership_members` INSERT RLS allows ANY authenticated user to join ANY partnership (breaks entire multi-tenancy model). Key discoveries: RLS policies all use `TO public` enabling anon key exploitation (H23-H24), RLS policy logic errors preventing partner visibility of category overrides (M125-M126), income_sources INSERT allows partner impersonation (M127), CASCADE DELETE from partnerships destroys 16+ tables (M131-M132), trigger functions lack search_path (M129-M130), FIRE calculation errors (M117-M118), budget period conversion loses ~8% for weekly (M119), income silently overwritten by webhook (M121), comprehensive business logic edge cases.
- **Iter 8**: 5 phases completed. ~44 raw findings across 5 agents (Phase 5 confirmed many clean areas). After dedup against 321 existing: +2 HIGH, +11 MEDIUM, +8 LOW, +1 INFO = 22 new unique findings. Key discoveries: concurrent webhook race conditions on goal balance (H26) and next_due_date advancement (H27), net worth/investment TOCTOU snapshot races (M138-M139), JSONB non-atomic updates (M140), empty `.in()` array in 6+ routes (M145), unvalidated notification_preferences JSONB in cron (M146), staleTimes.dynamic 180s extends stale auth window (M147), ai_model no allowlist (M148), 8 LOWs covering race conditions and validation gaps. Phase 5 confirmed zero instances of eval/innerHTML/dangerouslySetInnerHTML, proper auth on all 47 server actions, correct auth callback redirect validation, secure token encryption, and clean dependency versions.
- **Iter 9**: 5 phases completed. Focused scans: environment-specific gaps, exhaustive input validation, complete partnership auth matrix, client-side security, webhook/cron deep dive. High duplication rate (~75% across phases) indicates approaching saturation. After dedup against 343 existing: +1 HIGH, +15 MEDIUM, +17 LOW, +2 INFO = 35 new unique findings. Key discoveries: `getUserPartnershipId` non-deterministic multi-partnership fragility (H28), server actions universally lack Zod validation (M149), cron externally callable without Vercel signature (M151), JOINT account non-deterministic lookup and partial merchant rules (M156-M157), unknown `recurrence_type` infinite loop (M162), `income_sources` DELETE RLS too permissive (M163), 17 LOWs covering input bounds, autocomplete, cross-region latency, double balance updates.
- **Iter 10**: 5 phases completed. Deep-dive scans: auth & session security, data export/import handling, error handling & info disclosure, SQL/RLS edge cases, config/infra/supply chain. HIGHEST yield iteration despite being the 10th pass — focused deep-dives into previously-superficially-covered areas. After dedup against 378 existing: +2 HIGH, +23 MEDIUM, +23 LOW, +12 INFO = 60 new unique findings. Key discoveries: auth cookies lack HttpOnly (H29, XSS escalation), signout outside CSRF scope (H30, cross-site global logout), `.or()` year filter logically broken for multi-year (M170, returns ALL transactions), merge_partnerships no link request validation (M165), C3 escalation to DoS via trigger interaction (M167), CSP unsafe-inline negates XSS protection (M185), CI uses npm while project uses pnpm (M186, security overrides ineffective), getVendorTransactionHistory completely broken (M168), CSV double-quote injection (M177), AI tools return raw Supabase errors (M180).
- **Iter 11**: 5 phases completed. Deep-dives: AI tools & prompt injection, webhook handler line-by-line, budget system security, savings/investments/FIRE, client-side components. NEW HIGHEST yield — 73 new findings. After dedup against 438 existing: +3 HIGH, +35 MEDIUM, +28 LOW, +7 INFO = 73 new unique findings. Key discoveries: client injects "system" role into AI chat (H31), null webhook_secret → predictable HMAC "null" key (H32), methodology POST skips Zod (H33), SETTLED overwrites AI categories (M192), processTransaction void = permanent transaction loss (M198), assigned_cents/expected_amount_cents accept negatives (M199-M200), parseFloat NaN flows to database in 6 components (M218), addFundsToGoal accepts negative amounts (M208), net_worth_snapshots missing UPDATE RLS (M209), CoinGecko URL parameter injection (M211).

## All Findings (Deduplicated)

### CRITICAL (3) — C3 is the most severe finding in the entire audit

- **C1**: Production secrets readable on disk in .env.local (service role key, Gemini API key, CRON_SECRET, Alpha Vantage key, Vercel OIDC token). Gitignored but present. [.env.local]
- **C2**: Placeholder encryption key `placeholder_32_character_key____` in .env.local/.env.demo — not valid 64-char hex. getPlaintextToken() silently falls back to plaintext in dev. Bank API tokens may be unencrypted. [.env.local, token-encryption.ts:87]
- **C3**: `partnership_members` INSERT RLS policy only checks `user_id = auth.uid()` — places **no constraint on `partnership_id`**. Any authenticated user who knows or guesses a partnership UUID can INSERT themselves as a member. Once joined, they inherit full read/write access to ALL partnership-scoped tables (budgets, transactions, goals, investments, expenses, net worth) because nearly all RLS policies chain through `partnership_members`. **Breaks the entire multi-tenancy authorization model.** [initial_schema.sql:1313] *(iter7)*

### HIGH (33)

- **H1**: `getBudgets` accepts arbitrary partnershipId without membership verification [actions/budgets.ts:67]
- **H2**: `createBudget` trusts client-supplied partnership_id [actions/budgets.ts:93]
- **H3**: `duplicateBudget` missing partnership ownership check [actions/budgets.ts:446]
- **H4**: Cron endpoint uses service role to access ALL user profiles, decrypt ALL AI API keys, create financial tools that bypass RLS [api/cron/notifications/route.ts:70-249]
- **H5**: AI write tools (9 tools) execute immediately with no programmatic confirmation gate — prompt injection can create/modify financial records [ai-tools.ts:2489-3074]
- **H6**: Weekly summary cron creates AI financial tools with service role client, AI-triggered writes bypass RLS entirely [api/cron/notifications/route.ts:249]
- **H7**: AI queryFinancialData ilike/like filter values from AI not escaped — prompt injection could exploit PostgREST patterns [ai-tools.ts:1337]
- **H8**: Demo credentials hardcoded in .env.demo (Supabase anon key JWT, demo email/password) [.env.demo]
- **H9**: Password change does not verify current password — `supabase.auth.updateUser({ password })` called without re-authentication. Session hijack = full account takeover. `currentPassword` state collected in UI but never sent. [settings/security/page.tsx:64] *(iter2)*
- **H10**: Account deletion only deletes profile row via client-side RLS, does NOT call `auth.admin.deleteUser()` — auth.users row persists, user can reset password and log back in. No server-side cascade. [settings/security/page.tsx:96] *(iter2)*
- **H11**: AI `updateSavingsGoal` tool UPDATE not scoped by partnership_id — `.eq("id", goal.id)` only. Via cron service-role client, could modify any goal. [ai-tools.ts:2714] *(iter2)*
- **H12**: AI `updateInvestment` tool UPDATE not scoped by partnership_id — `.eq("id", inv.id)` only. Same service-role risk as H11. [ai-tools.ts:3045] *(iter2)*
- **H13**: `aiCategorizeTransaction` uses service role client. `accountIds` parameter from caller not verified within function. UPDATE by transaction ID only — no ownership check. [ai-categorize.ts:36] *(iter2)*
- **H14**: Webhook `processTransactionDeletion` searches `up_transaction_id` globally with service role — no account_id scoping. Contrast: `processTransaction` correctly scopes by `up_account_id`. [webhook/route.ts:616] *(iter2)*
- **H15**: Webhook createdAt NaN bypasses replay protection — `new Date(malformed).getTime()` = NaN, `Math.abs(NaN - now) > FIVE_MINUTES` = false. Malformed createdAt with valid HMAC passes replay check. [webhook/route.ts:700] *(iter2)*
- **H16**: AI indirect prompt injection chain — malicious transaction descriptions processed by AI with write-capable tools can trigger unauthorized financial operations (create budgets, modify goals, recategorize). Attacker plants crafted descriptions → AI reads them → AI executes write tools. [ai-tools.ts, ai/chat/route.ts] *(iter3)*
- **H17**: Goals edit page `/goals/[id]/edit` has client-only auth — no server-side ownership check. Any authenticated user can edit any goal by navigating to the URL with a known goal ID. [goals/[id]/edit/page.tsx] *(iter5)*
- **H18**: SSRF via Up Bank API pagination URLs — `getAllPages()` follows `nextUrl` from API response without validating it points to `api.up.com.au`. Bearer token is sent to whatever URL the response specifies. Same pattern in sync route pagination loops. [up-api.ts:399, sync/route.ts:104,221] *(iter5)*
- **H19**: Account deletion orphans partnership data + profiles table has NO DELETE RLS policy. `supabase.from("profiles").delete()` silently fails via RLS. Even if it worked, partnership-scoped data (goals, investments, expenses, budgets) persists while user's accounts/transactions are cascade-deleted, leaving broken references. [settings/security/page.tsx:96, initial_schema.sql:1321] *(iter5)*
- **H20**: No partnership departure mechanism — locked-in partners. `partnership_members` has no DELETE or UPDATE RLS policy. No server action to leave a partnership. No UI to unlink. Former partners retain mutual access to all financial data indefinitely. [initial_schema.sql:1312-1313] *(iter5)*
- **H21**: `transaction_share_overrides.transaction_id` is `text` but `transactions.id` is `uuid`. NO foreign key constraint exists. Any arbitrary string stored as transaction_id; no cascade on transaction deletion; type mismatch prevents adding FK without migration. [initial_schema.sql:390,974] *(iter5)*
- **H22**: `merge_partnerships` does not migrate 10+ tables before cascade-deleting joining partnership. `user_budgets`, `budget_item_preferences`, `budget_category_shares`, `net_worth_snapshots`, `milestones`, `annual_checkups`, `watchlist_items`, `target_allocations`, `methodology_customizations`, `category_pin_states`, `budget_layout_presets` are all permanently destroyed. [20260226_security_fixes.sql:103-169] *(iter5)*
- **H23**: ALL RLS policies use `TO public` instead of `TO authenticated` — policy evaluation runs for `anon` (unauthenticated) role. Combined with `WITH CHECK (true)` policies on `categories`, `partnerships`, and `tags` INSERT, the anon key can INSERT rows into these tables without authentication. [initial_schema.sql:1185-1398] *(iter7)*
- **H24**: `partnerships` INSERT policy `WITH CHECK (true)` combined with `TO public` — the Supabase anon key (exposed in client bundle) can create unlimited partnership rows. When combined with C3 (`partnership_members` INSERT IDOR), an attacker using just the anon key could create partnerships and join them. Escalates L41. [initial_schema.sql:1318] *(iter7)*
- **H25**: `invalidate_expense_match_on_recategorize` trigger performs `DELETE FROM expense_matches WHERE transaction_id = NEW.id` without partnership scoping. Triggers bypass RLS. If a user's transaction was matched to another partnership's expense definition (possible with shared bank accounts), recategorizing the transaction deletes the cross-partnership expense match. [initial_schema.sql:95-106] *(iter7)*
- **H26**: Concurrent webhook goal balance sync — lost update race condition. Two webhooks for different accounts linked to the same savings goal both read `current_amount_cents`, calculate independent deltas, and write back. Second write overwrites first. No database-level locking or conditional update. [webhook/route.ts:262-307] *(iter8)*
- **H27**: Webhook `next_due_date` advancement race — two transactions from same merchant arriving simultaneously (auth hold + settlement) both read stale `next_due_date`, both advance it. One can skip a period entirely. `expense_matches` has `ignoreDuplicates` but `next_due_date` update has no CAS guard. [match-expense-transactions.ts:350-379] *(iter8)*
- **H28**: `getUserPartnershipId` returns non-deterministic first partnership — uses `.limit(1).maybeSingle()` with no `ORDER BY`. Schema allows multi-partnership membership (no unique constraint on `partnership_members.user_id`). All 15+ server actions using this function operate on whichever partnership Postgres returns first. User in partnerships A and B may have actions silently split across both. Data from second partnership inaccessible via server actions. [get-user-partnership.ts:9-21] *(iter9)*
- **H29**: Auth cookies lack `httpOnly` flag — `@supabase/ssr DEFAULT_COOKIE_OPTIONS` sets `httpOnly: false` and omits `secure`. Application never overrides. Access/refresh tokens readable by client-side JavaScript via `document.cookie`. Any XSS vulnerability enables full session token exfiltration. [node_modules/@supabase/ssr/src/utils/constants.ts:6, utils/supabase/server.ts, middleware.ts, client.ts] *(iter10)*
- **H30**: Signout route `/auth/signout` outside CSRF scope — CSRF check only covers `/api/` paths (line 95). Cross-site form POST forces `signOut()` with default `scope: 'global'`, revoking ALL sessions on ALL devices. SameSite=Lax allows cross-site form POSTs. [utils/supabase/middleware.ts:95, auth/signout/route.ts] *(iter10)*
- **H31**: Client can inject "system" role messages into AI conversation — `ChatMessageSchema` accepts `role: z.enum(["user", "assistant", "system"])`. Malicious client sends messages with `role: "system"` to override server-set safety instructions and write-tool restrictions. Schema should only allow "user" and "assistant" from client submissions. [ai/chat/route.ts:17-24] *(iter11)*
- **H32**: Null `webhook_secret` creates predictable HMAC key — `up_api_configs.webhook_secret` is nullable. `getPlaintextToken(null)` returns null. `createHmac("sha256", null)` coerces null to string `"null"`, producing deterministic HMAC. Attacker discovering a `webhook_id` with null secret can forge valid signatures. Config lookup only requires matching `webhook_id`, not `IS NOT NULL` on secret. [webhook/route.ts:693, token-encryption.ts:88] *(iter11)*
- **H33**: Methodology customization POST skips Zod validation — uses raw `request.json()` instead of `parseBody()`. `custom_categories`, `hidden_subcategories`, and `is_partnership_wide` not schema-validated. Attacker can inject arbitrary fields, prototype-polluting keys in `underlyingCategories`, or set `is_partnership_wide: true` bypassing role check if `membership.role` is undefined. Extends M45 with injection risk analysis. [budget/methodology/customize/route.ts:147-154] *(iter11)*

### MEDIUM (221)

- **M1**: Middleware protectedPaths may be incomplete (added /analysis, /notifications, /dev but verify all) [middleware.ts:90]
- **M2**: CSP script-src 'unsafe-inline' weakens XSS protection [next.config.ts:20]
- **M3**: Webhook no event ID deduplication — replay possible within 5-min window [webhook/route.ts:699]
- **M4**: Webhook secret was stored unencrypted (now encrypted, but existing records may be plaintext) [initial_schema.sql:647]
- **M5**: Bulk shares PATCH — percentage bounds + array limits needed [shares/categories/route.ts:184]
- **M6**: Widespread select("*") returning all columns (35+ instances across routes/actions) [multiple files]
- **M7**: AI queryFinancialData — goal_contributions and investment_history rely on RLS only, no app-level scoping [ai-tools.ts:1306]
- **M8**: Password min length only 8 chars, client-side only, no complexity requirements [signup/page.tsx:42]
- **M9**: No rate limiting on login/signup/forgot-password [auth pages]
- **M10**: `createIncomeSource` trusts client partnership_id [income-sources.ts:36]
- **M11**: `getManualPartnerIncomeSources` missing partnership check [income-sources.ts:115]
- **M12**: `getExpenseForTransaction` missing transaction ownership check [expenses.ts:197]
- **M13**: In-memory rate limiter resets on serverless cold start — all limiters bypassable [rate-limiter.ts]
- **M14**: AI searchTransactions amount values interpolated into .or() filter strings [ai-tools.ts:155]
- **M15**: Legacy match_pattern field passed to .ilike() without escaping [match-expense-transactions.ts:106]
- **M16**: Demo mode mutation blocking only applies to /api/ routes, not Server Actions [middleware.ts:41]
- **M17**: Expense match creation does not verify transaction ownership [expenses/match/route.ts:50]
- **M18**: Transaction override POST does not verify transaction belongs to partnership [transaction-overrides/route.ts:62]
- **M19**: addFundsToGoal allows negative amounts — can drain goals [goals.ts:61]
- **M20**: Categories table INSERT policy WITH CHECK (true) — any auth'd user can insert [initial_schema.sql:1226]
- **M21**: Cron notification handler accesses all user AI API keys in memory [cron/notifications/route.ts:172]
- **M22**: AI chat system prompt enables prompt injection reconnaissance (schema details exposed) [ai/chat/route.ts:133]
- **M23**: Token encryption disabled in non-production — dev database dumps contain plaintext tokens [token-encryption.ts:87]
- **M24**: No structured audit logging for security events (failed logins, auth failures, rate limits) [entire codebase]
- **M25**: 22 of 32 API routes have no rate limiting [api/*]
- **M26**: Most endpoints lack Zod schema validation on request bodies (only 3 of 32 routes use Zod) [api/*]
- **M27**: Budget layout GET/POST does not verify partnership membership [budget/layout/route.ts:15,106]
- **M28**: Budget templates GET/POST does not verify partnership membership [budget/templates/route.ts:13,78]
- **M29**: Transactions summary fetches ALL matching rows in batches — no limit on total [transactions/route.ts:332]
- **M30**: .or() string interpolation with user.id from auth (fragile pattern, 5+ locations) [multiple files]
- **M31**: `deep_link_url` rendered as `<a href>` without URL scheme validation — javascript: or data: URLs from corrupted DB could execute. [transaction-detail-modal.tsx:460] *(iter2)*
- **M32**: Prompt injection via transaction descriptions in AI expense auto-detect — merchant names interpolated directly into LLM prompt without sanitization. [auto-detect/route.ts:260] *(iter2)*
- **M33**: Prompt injection via transaction descriptions in AI categorization — description embedded verbatim in prompt template. [ai-categorize.ts:106] *(iter2)*
- **M34**: AI `recategorizeTransaction` tool UPDATE only filters by `.eq("id", txnId)` — no account scoping on the write. [ai-tools.ts:2811] *(iter2)*
- **M35**: AI `createBudgetAssignment` allows negative `assigned_cents` — corrupts TBB calculations. [ai-tools.ts:~2295] *(iter2)*
- **M36**: CoinGecko coinId derived from user-controlled ticker without URL encoding — `symbol.toLowerCase()` interpolated directly into URL. [price-apis.ts:84] *(iter2)*
- **M37**: `getVendorTransactionHistory` uses legacy `owner_id/partner_id` auth pattern (not partnership_members table). [expenses.ts:317] *(iter2)*
- **M38**: Budget columns GET/POST does not verify partnership membership. [budget/columns/route.ts:11] *(iter2)*
- **M39**: `net_worth_snapshots` table has INSERT + SELECT RLS policies but no UPDATE or DELETE policies. [initial_schema.sql:1298] *(iter2)*
- **M40**: `budget_months` table has INSERT + UPDATE + SELECT policies but no DELETE policy. [initial_schema.sql:1216] *(iter2)*
- **M41**: `saveCheckupStep` accepts arbitrary `Record<string, unknown>` merged via spread into JSONB — no schema, no size limit. [checkup.ts:58] *(iter2)*
- **M42**: `completeOnboarding` stores arbitrary string array `stepsCompleted` without length/content validation. [onboarding.ts:6] *(iter2)*
- **M43**: checkup.ts `startOrResumeCheckup`/`saveCheckupStep` use null `partnershipId` in insert without guard — could create row with `partnership_id: null`. [checkup.ts:26] *(iter2)*
- **M44**: invest/[id]/page.tsx fetches investment by ID BEFORE verifying partnership ownership — data fetch precedes auth check. [invest/[id]/page.tsx:20] *(iter2)*
- **M45**: methodology/customize POST uses raw `request.json()` without Zod validation (diverges from codebase standard). [customize/route.ts:147] *(iter2)*
- **M46**: `updateGoal` allows direct manipulation of `current_amount_cents` and `target_amount_cents` without numeric validation — can set negative or zero values. [goals.ts:296] *(iter2)*
- **M47**: Notification action handler trusts metadata `expense_id`/`transaction_id` without UUID validation and `new_amount_cents` without bounds check. [notifications/[id]/action/route.ts:70] *(iter2)*
- **M48**: No audit trail for expense amount changes via notification actions — old value not recorded. [notifications/[id]/action/route.ts:112] *(iter2)*
- **M49**: AI context endpoint `/api/ai/context` has no rate limiting — returns full financial summary with 6+ DB queries per call. [ai/context/route.ts:4] *(iter2)*
- **M50**: CSRF check bypassed when Origin header absent — `if (appUrl && origin && ...)` fails open. Non-browser clients or proxies stripping Origin bypass check entirely. [middleware.ts:98] *(iter2)*
- **M51**: Webhook SETTLED fallback path updates transaction status without verifying account ownership (service role, unscoped). [webhook/route.ts:736] *(iter2)*
- **M52**: `backfill-all` endpoint runs all expense matching via `Promise.all()` with no concurrency limit — thundering herd of DB queries. [expenses/backfill-all/route.ts:60] *(iter2)*
- **M53**: Formula evaluator has no recursion depth limit or token count limit — deeply nested expressions could cause stack overflow. [formula-evaluator.ts:166] *(iter2)*
- **M54**: App layout `select("*")` on profiles fetches encrypted AI API keys into server memory on every page load — unnecessary exposure surface. [layout.tsx:39] *(iter2)*
- **M55**: Yahoo Finance API response data trusted without schema validation — `regularMarketPrice` field used in financial calculations without type check. [price-apis.ts:182] *(iter2)*
- **M56**: `notifications` table missing DELETE RLS policy — old notifications cannot be cleaned up, or could be deleted by any auth'd user if policy is overly permissive. [initial_schema.sql] *(iter3)*
- **M57**: `partner_link_requests` table RLS policies may not scope correctly to involved parties — requests visible/modifiable across partnerships. [initial_schema.sql] *(iter3)*
- **M58**: `investment_history` table missing UPDATE/DELETE RLS policies — historical value snapshots could be tampered with or deleted. [initial_schema.sql] *(iter3)*
- **M59**: `transaction_tags` table missing DELETE RLS policy — tags persist even after user deletion attempts. [initial_schema.sql] *(iter3)*
- **M60**: `transaction_notes` table missing DELETE RLS policy — notes undeletable or deletable by wrong user. [initial_schema.sql] *(iter3)*
- **M61**: `savings_goal_contributions` table missing UPDATE/DELETE RLS policies — contribution history could be tampered. [initial_schema.sql] *(iter3)*
- **M62**: Missing Cache-Control/no-store headers on ALL sensitive API routes — browser/CDN could cache financial data responses. [all API routes] *(iter3)*
- **M63**: ChatMessageSchema uses Zod `.passthrough()` — allows arbitrary extra fields in AI chat messages, potential for injection of unexpected data. [ai/chat/route.ts] *(iter3)*
- **M64**: Streaming UP Bank sync doesn't re-verify auth during long-running operation — token could be revoked mid-sync but operation continues. [upbank/sync/route.ts] *(iter3)*
- **M65**: `merge_partnerships` function lacks validation that both parties have explicitly consented to the merge. [partnerships or related] *(iter3)*
- **M66**: Zero uses of `AbortController` across entire codebase — all `useEffect` data fetches vulnerable to stale-data overwrites when dependencies change rapidly. Rapidly clicking budget rows shows wrong category's transactions. [budget-detail-panel.tsx:182, transaction-link.tsx:31, transaction-history.tsx:40, settings/profile/page.tsx:38] *(iter3)*
- **M67**: Activity client `useEffect` depends on 14 state variables with no debounce — every keystroke in search fires full API call. Typing "coffee" = 6 rapid API calls with race conditions. [activity-client.tsx:197-263] *(iter3)*
- **M68**: Notification polling continues indefinitely after session expiry — 30s `setInterval` fetch silently swallows 401 errors, masking session expiry from user and generating server load. [notification-bell.tsx:70-87] *(iter3)*
- **M69**: Error boundaries `console.error(error)` in client logs full Error object to browser dev tools — 8 error.tsx files expose error details. [error.tsx:14, budget/error.tsx:14, +6 more] *(iter3)*
- **M70**: AI chat `remarkGfm` plugin auto-links URL-like strings in AI output — attacker-crafted transaction descriptions containing URLs could become clickable links in AI responses. [piggy-chat.tsx:115-125] *(iter3)*
- **M71**: CSRF `origin.startsWith(appUrl)` prefix match — if `appUrl` is `https://piggyback.app`, attacker at `https://piggyback.app.evil.com` passes the check. Distinct from M50 (null origin bypass). [middleware.ts:98] *(iter4)*
- **M72**: `createIncomeSourceFromTransaction` duplicate check uses `.eq('linked_up_transaction_id', transaction.up_transaction_id)` — if `up_transaction_id` is null, matches ALL income sources with null `linked_up_transaction_id`, potentially returning wrong user's source. [income.ts:152-163] *(iter4)*
- **M73**: `updateIncomeSource` scoped by `user_id` only, not partnership — user who left partnership A and joined B can still modify their old income sources from A. [income-sources.ts:160-199] *(iter4)*
- **M74**: `refreshAllPrices` investment update uses `.eq("id", inv.id)` without `.eq("partnership_id", ...)` — initial fetch is scoped but loop update drops partnership scope (defense-in-depth gap). [investments.ts:360-367] *(iter4)*
- **M75**: Expense definition accepts negative `expected_amount_cents` — no server-side validation on insert or update. Negative expected amounts corrupt budget projections and expense matching. [budget/expenses/route.ts] *(iter5)*
- **M76**: Layout import accepts arbitrary JSON without schema validation; no `__proto__` sanitization. Malicious layout JSON can inject prototype pollution payloads, oversized arrays, or HTML in section names. Stored in DB and loaded in subsequent sessions. [layout-persistence.ts:66-95, budget-layout-context.tsx:679] *(iter5)*
- **M77**: `category_mappings` table RLS has only SELECT policy with `USING (true)` — any unauthenticated request can read all category mappings. No INSERT/UPDATE/DELETE policies exist. [initial_schema.sql:1232] *(iter5)*
- **M78**: AI settings PUT endpoint accepts raw `request.json()` without Zod validation — AI API keys and provider settings accepted without schema check. [ai/settings/route.ts] *(iter5)*
- **M79**: Transaction API `limit` query parameter unbounded — user can request `limit=999999`. Combined with M29 (summary batch loop), enables resource exhaustion. [transactions/route.ts:14] *(iter5)*
- **M80**: `merge_partnerships` does not validate that `p_primary_partnership_id` belongs to requesting partner or corresponds to valid `partner_link_request`. Attacker calls `merge_partnerships(victim_partnership_id, attacker_user_id, attacker_partnership_id, random_uuid)` — only check is `auth.uid() == attacker_user_id`. Refines M65. [20260226_security_fixes.sql:103-169] *(iter5)*
- **M81**: `addFundsToGoal` read-then-write race condition — concurrent requests both read same `current_amount_cents`, both add delta, last write wins. Lost-update results in incorrect goal balance. Contribution history records also fire-and-forget, compounding inconsistency. [goals.ts:80-111] *(iter5)*
- **M82**: Encryption key rotation permanently destroys all stored tokens. No key versioning in encrypted format (`iv:authTag:ciphertext`). No migration utility. Single key encrypts bank tokens, webhook secrets, AND AI API keys. Key compromise = rotate = all users lose access. [token-encryption.ts] *(iter5)*
- **M83**: `setDefaultBudget` non-atomic toggle — clears ALL defaults in step 1, sets new default in step 2. Concurrent calls create zero or multiple defaults. Step 2 failure after step 1 = no default budget. [budgets.ts:419-458] *(iter5)*
- **M84**: CSV export formula injection bypass via unescaped double-quote characters. `sanitizeCsvCell` prefixes dangerous chars at start, but description containing `"=cmd|'/C calc'!A0` breaks out of quoted CSV field. Extends L38. [export/transactions/route.ts:98-121] *(iter5)*
- **M85**: Account deletion does not deregister UP Bank webhook. Stale webhook persists, UP Bank retries for 72h generating load. New user on same bank account could get duplicate transaction processing. [settings/security/page.tsx:82-107, webhook/route.ts] *(iter5)*
- **M86**: Next.js image optimization acts as open proxy — no `remotePatterns` restriction. `/_next/image?url=...` proxies any HTTPS URL through the server. Combined with CSP `img-src https:`, enables SSRF, CSP bypass, and resource exhaustion. [next.config.ts:35-38] *(iter5)*
- **M87**: Up Bank API token transmitted in plaintext via server action `connectUpBank(plaintextToken)`. Token passes through Next.js middleware, server action serialization, and potentially request logging. Stored in React state and DOM password input. [upbank.ts:272, bank-step.tsx:38] *(iter5)*
- **M88**: `handle_new_profile` SECURITY DEFINER trigger creates partnership + membership without dedup guard. If trigger fires twice (race condition in profile creation), duplicate partnerships created. `LIMIT 1` SELECT could miss first insert if not yet committed. [initial_schema.sql:45-73] *(iter5)*
- **M89**: `income_sources` has no unique constraint — duplicate income sources with same name, amount, pattern can be created, double-counting income in budget calculations. [initial_schema.sql:568-590] *(iter5)*
- **M90**: `budget_assignments` unique index misses `stored_period_type` column — two rows with same (partnership_id, month, budget_view, assignment_type, category_name) but different period types allowed, causing calculation confusion. [initial_schema.sql:1004] *(iter5)*
- **M91**: `income_sources.user_id` has NO foreign key to `profiles` — income sources can reference non-existent users, no cascade on profile deletion, orphan rows persist. [initial_schema.sql:570] *(iter5)*
- **M92**: `income_sources.partnership_id` is nullable — bypasses partnership-scoped RLS. Income source with NULL partnership_id is invisible to partner but visible to owner, creating hidden data. [initial_schema.sql:571] *(iter5)*
- **M93**: `share_percentage` columns on `transaction_share_overrides` and `budget_category_shares` have no CHECK constraint — accept any integer including negative or >100. Corrupts budget split calculations. [initial_schema.sql:392,527] *(iter5)*
- **M94**: `invalidate_expense_match_on_recategorize` trigger deletes expense_matches without rolling back `next_due_date` on expense_definition. Recategorized transaction leaves expense in "unpaid for past period" state with future next_due_date. [initial_schema.sql:95-106] *(iter5)*
- **M95**: `categories.parent_category_id` FK has no cascade action (default RESTRICT). Categories with children, mappings, or merchant rules become undeletable. [initial_schema.sql:934] *(iter5)*
- **M96**: `expense_matches` table missing UPDATE RLS policy — match metadata (confidence, period) cannot be corrected via client. [initial_schema.sql:1250-1252] *(iter5)*
- **M97**: `updateGoal` accepts `linked_account_id` without verifying the account belongs to user's partnership — IDOR allows linking goal to another user's bank account. [goals.ts:271,301] *(iter6)*
- **M98**: `deleteIncomeSource` scoped by `user_id` only, no partnership check — inconsistent with `createIncomeSource` which verifies partnership membership. [income-sources.ts:205-227] *(iter6)*
- **M99**: `createIncomeSourceFromTransaction` no validation on `options.customName`, `options.oneOffType`, `options.recurrence` — stored directly in DB. [income.ts:100-265] *(iter6)*
- **M100**: `createInvestment` `ticker_symbol` not validated — user-controlled string flows into Yahoo Finance/CoinGecko API URLs. Could inject query params or path segments. [investments.ts:11-73, price-apis.ts:143] *(iter6)*
- **M101**: No custom session lifetime — Supabase refresh tokens live indefinitely. Middleware refreshes session on every request, keeping stolen tokens valid forever. No absolute session expiry. [utils/supabase/middleware.ts, client.ts, server.ts] *(iter6)*
- **M102**: No session invalidation on password change — `auth.signOut({ scope: 'others' })` never called. Attacker's existing session remains valid after victim changes password. [settings/security/page.tsx] *(iter6)*
- **M103**: Goals detail page `/goals/[id]/page.tsx` initial query fetches by ID without partnership filter — data loaded into server memory before partnership check and redirect. Timing side-channel distinguishes "exists elsewhere" from "not found". [goals/[id]/page.tsx:25-48] *(iter6)*
- **M104**: Avatar URL enables partner surveillance — user can set avatar to tracking pixel URL (`https://evil.com/track?t=`), partner's IP/browser/access patterns leaked on every page load showing the avatar. [settings/profile/page.tsx:148-162] *(iter6)*
- **M105**: CSP `connect-src` allows all 3 AI providers simultaneously (OpenAI, Anthropic, Google) even though user configures only one — XSS can exfiltrate data to any whitelisted AI domain. [next.config.ts:24, vercel.json:50] *(iter6)*
- **M106**: External API calls to Yahoo Finance and CoinGecko have no `AbortController` timeout — slow/unresponsive external API blocks server rendering indefinitely. DoS vector for investment pages. [price-apis.ts:24-178] *(iter6)*
- **M107**: Budget summary endpoint fetches `user_budgets` by ID before verifying partnership membership — leaks budget existence and `partnership_id` via 403/404 distinction. [budget/summary/route.ts:59-76] *(iter6)*
- **M108**: Methodology POST saves `budget_methodology` to user's `profiles` row despite accepting and validating `partnership_id` — partnership_id verified but not used for write. Any string up to 50 chars stored. [budget/methodology/route.ts:85-91] *(iter6)*
- **M109**: Budget zero/assign endpoint Zod schema validates `assigned_cents` as `z.number().int()` with no min/max — accepts negative or extremely large values. [budget/zero/assign/route.ts:43] *(iter6)*
- **M110**: Methodology customize DELETE handler missing partnership membership check — validates methodology name but doesn't verify user is member of specified partnershipId. [budget/methodology/customize/route.ts:252-321] *(iter6)*
- **M111**: Budget summary API hardcodes `split_override_percentage: null` — transaction-level split overrides from `transaction_share_overrides` are never applied in server-rendered budget summary. Client-side budget shell may apply them, creating divergent budget views between API and client rendering. Partner could set overrides visible only in client view. [budget/summary/route.ts:318] *(iter6)*
- **M112**: Investment `ticker_symbol` changeable at any time without validation — user can update ticker to a different asset (e.g., penny stock → AAPL), then call `updateInvestmentPriceFromAPI` to inflate investment value. Corrupts net worth snapshots, portfolio allocation, FIRE projections. No consistency check between ticker and named asset. [investments.ts:76, price-apis.ts:143] *(iter6)*
- **M113**: Negative `expected_amount_cents` on expense definitions creates phantom budget income — budget engine's expense defaults subtract from budgeted total instead of adding, effectively injecting fake income. Combined with duplicate income sources (M89), budget can show far more available funds than reality. [budget/expenses/route.ts, budget-engine.ts] *(iter6)*
- **M114**: 9+ settings/goal pages are client-only components querying Supabase directly without server-side data fetching — rely entirely on RLS for data isolation. Includes security page, profile, notifications, UP connection, income, partner, FIRE settings, goal edit, goal new. Any RLS gaps are directly exploitable from browser. [settings/*/page.tsx, goals/*/page.tsx] *(iter6)*
- **M115**: `removeCustomColumn` calls nonexistent `DELETE /api/budget/columns/${columnId}` endpoint — no route handler exists. Custom columns can be created but never deleted. Columns with problematic formulas (evaluated via formula-evaluator) persist permanently. [budget-layout-context.tsx:507-526] *(iter6)*
- **M116**: `/update-password` page in `(auth)` group has no middleware or layout auth protection — not listed in middleware `protectedPaths`, and `(auth)` layout has no auth check. Page renders for unauthenticated users. The `supabase.auth.updateUser()` call requires a valid session (set via recovery token in URL hash), so practical impact is limited, but the form UI renders unnecessarily for unauthenticated visitors. [update-password/page.tsx, middleware.ts:104] *(iter7)*
- **M117**: FIRE `runProjection` produces oscillating/negative portfolio values when `expectedReturnRate <= -100%` — `Math.round(outsideSuper * (1 + rate))` flips sign each iteration. Chart displays negative portfolio values. No upper bound on growth rates either — 999% produces astronomical projections. Deepens L42. [fire-calculations.ts:603-675] *(iter7)*
- **M118**: FIRE two-bucket breakdown ignores compound growth during gap period — `outsideSuperTargetCents = annualExpenses * yearsPreRetirement` is a raw multiplication that doesn't account for investment returns during the pre-preservation-age gap. Systematically inflates outside-super target by ~40% for 20-year gaps at 7% return, causing users to delay retirement unnecessarily. [fire-calculations.ts:185-217] *(iter7)*
- **M119**: Budget period conversion loses ~8% for weekly frequencies — `weekly * 4 = monthly` approximation understates actual 4.33 weeks/month. User with $1000/week income sees $4000/month budgeted vs actual $4333. Same issue for fortnightly (* 2 vs * 2.17). Both income and expense defaults affected. Duplicated in `income-frequency-converter.ts`. [budget-engine.ts:254-296] *(iter7)*
- **M120**: `updateGoal` allows direct `current_amount_cents` manipulation without creating `goal_contributions` record — bypasses contribution audit trail entirely. No milestone notifications fire. Goal history chart (based on contributions) becomes incorrect. Can set balance to any value including exceeding target or resetting to 0 while keeping `is_completed: true`. [goals.ts:261-322] *(iter7)*
- **M121**: Income source `amount_cents` silently overwritten by webhook match — `matchSingleTransactionToIncomeSources()` auto-updates income source amount to match latest transaction without notification. Atypical pay (e.g., partial pay due to leave) permanently corrupts budget income calculations. No confirmation or undo mechanism. [match-expense-transactions.ts:525-559] *(iter7)*
- **M122**: Multi-expense subcategory collision corrupts split calculations — when multiple expense definitions map to same subcategory key, amounts are summed but split settings use only the first expense's `expense_definition_id`. Combined expenses use wrong partner share percentage. [budget-engine.ts:701-745] *(iter7)*
- **M123**: Stale income sources inflate TBB indefinitely — recurring income sources with `is_active: true` persist and count toward every budget period regardless of whether pay was actually received. No automatic deactivation when payments stop. User who loses job continues to see full salary in budget. [budget-engine.ts:395-420] *(iter7)*
- **M124**: `merge_partnerships` SECURITY DEFINER allows pushing attacker-controlled data INTO any partnership — auth check only verifies `auth.uid() = p_joining_user_id`, not that caller is member of `p_primary_partnership_id`. Attacker calls `merge_partnerships(victim_id, auth.uid(), attacker_id, any_uuid)` to inject their income sources, expenses, goals, investments into victim's partnership. Refines M80 with data-flow direction. [20260226_security_fixes.sql:103-169] *(iter7)*
- **M125**: `transaction_category_overrides` SELECT RLS policy has logically redundant JOIN — `partnership_members pm ON (pm.user_id = a.user_id) WHERE pm.user_id = auth.uid()` reduces to `a.user_id = auth.uid()`. Partners CANNOT see category overrides on each other's transactions even though they can see the transactions themselves. Creates inconsistent recategorization visibility. [initial_schema.sql:1345] *(iter7)*
- **M126**: `transaction_category_overrides` INSERT/UPDATE/DELETE RLS requires `changed_by = auth.uid()` AND transaction owned by caller — partner cannot manage overrides on shared/JOINT account transactions even though they can view them. Asymmetric control on shared financial data. [initial_schema.sql:1342-1344] *(iter7)*
- **M127**: `income_sources` has overlapping INSERT RLS — "Partners can insert income for each other" policy allows User A to insert records with `user_id = User B's ID` (partner). Enables income impersonation — any partnership member can create income sources attributed to their partner, inflating that partner's income calculations. [initial_schema.sql:1256-1258] *(iter7)*
- **M128**: `methodology_customizations` FOR ALL policy allows owners to modify shared (NULL user_id) customizations but not non-owner members — creates confusing dual-path with separate SELECT policy. Members can read but not write shared customizations. [initial_schema.sql:1288] *(iter7)*
- **M129**: Trigger functions `handle_updated_at()`, `update_share_updated_at()`, `update_user_budgets_updated_at()` lack `SET search_path` — called via BEFORE UPDATE triggers on 14+ tables. A user with CREATE privilege could shadow `timezone()` function. [initial_schema.sql:22-30, 75-86] *(iter7)*
- **M130**: `invalidate_expense_match_on_recategorize` trigger function lacks `SET search_path` and references unqualified `expense_matches` table. When webhook handler (service role) updates transactions, this trigger fires with full privileges, able to delete ANY expense_match. [initial_schema.sql:95-106] *(iter7)*
- **M131**: CASCADE DELETE on `partnerships` propagates to 16+ tables — single partnership deletion destroys ALL financial data: budget_assignments, budgets, couple_split_settings, expense_definitions (→ expense_matches), income_sources, investments (→ investment_history, investment_contributions), milestones, annual_checkups, net_worth_snapshots, savings_goals (→ goal_contributions), target_allocations, user_budgets, watchlist_items. The `merge_partnerships` function triggers this cascade at line 159. [initial_schema.sql:914-985] *(iter7)*
- **M132**: CASCADE DELETE on `accounts` (via profile deletion) destroys ALL transactions and related data — each transaction deletion cascades to expense_matches, transaction_notes, transaction_tags, transaction_category_overrides. If profile deletion DID work (currently blocked by H10), it would destroy all transaction history across partnership via shared account references. [initial_schema.sql:912,977] *(iter7)*
- **M133**: `goal_contributions` table has no UPDATE RLS policy — contribution records immutable by omission, not intent. `balance_after_cents` cannot be corrected if concurrent updates create inconsistencies. Delete-and-recreate required for corrections. [20260226_security_fixes.sql:57-95] *(iter7)*
- **M134**: `analysis/page.tsx` uses `export const revalidate = 300` — ISR caching on authenticated page. Next.js may cache rendered HTML for 300 seconds. If cookies are not treated as cache key, User A's financial analysis could be served to User B. Risk depends on Next.js ISR + cookie interaction. [analysis/page.tsx:7] *(iter7)*
- **M135**: `upsert_up_api_config` SECURITY DEFINER returns `SQLERRM` in error responses — raw Postgres error messages leak internal database details (table names, constraint names, column types) to authenticated callers via `.rpc()`. [20260226_security_fixes.sql:210-214] *(iter7)*
- **M136**: Initial schema migration still contains `WITH CHECK (true)` INSERT policies on `categories` and `tags` that fix migration later removes — schema drift risk if DB reset from initial schema without applying fix migration. [initial_schema.sql:1226,1331 vs 20260226_security_fixes.sql:177,223] *(iter7)*
- **M137**: `merge_partnerships` has no explicit transaction isolation or advisory locking — concurrent merge requests from both partners could interleave UPDATE/DELETE/INSERT operations. `ON CONFLICT DO NOTHING` prevents duplicate members but leaves data in inconsistent state. [20260226_security_fixes.sql:103-169] *(iter7)*
- **M138**: Net worth snapshot upsert TOCTOU — webhook `updateAccountBalance` checks if today's snapshot exists, then inserts if not. Two concurrent webhooks both see no existing snapshot, both insert, creating duplicate rows. `total_balance_cents` calculation reads accounts mid-flight during concurrent updates. [webhook/route.ts:370-395] *(iter8)*
- **M139**: `upsertInvestmentNetWorth` same TOCTOU pattern — `refreshAllPrices()` and webhook handler can race creating duplicate net worth snapshots for same date. No unique constraint on `(partnership_id, snapshot_date)`. [net-worth-helpers.ts:25-55] *(iter8)*
- **M140**: `toggleGoalChecklistItem` non-atomic JSONB update — reads entire `preparation_checklist` array, toggles one element in-memory, writes whole array back. Both partners toggling different items simultaneously — second write overwrites first partner's change. [goals.ts:341-369] *(iter8)*
- **M141**: `createBudget` first-budget default race — both partners simultaneously creating first budget both see `count === 0`, both set `is_default: true`, violating single-default assumption. [budgets.ts:123-156] *(iter8)*
- **M142**: `createIncomeSourceFromTransaction` TOCTOU on duplicate check — checks `linked_up_transaction_id` then inserts without unique constraint. Rapid double-click or concurrent webhook creates duplicate income sources. [income.ts:153-163] *(iter8)*
- **M143**: Security headers missing from raw `Response` objects — streaming NDJSON (`sync/route.ts:412`), CSV/Markdown exports (`export/transactions/route.ts:128`), and AI chat stream (`ai/chat/route.ts:295`) use `new Response()` which may bypass Next.js `headers()` config security headers (CSP, HSTS, nosniff) on Vercel edge/serverless. [sync/route.ts, export/transactions/route.ts, ai/chat/route.ts] *(iter8)*
- **M144**: `years` query parameter generates unbounded `.or()` filter — no cap on year count. `?years=2000,2001,...,2199` generates 200-clause OR filter (~20KB PostgREST string). `accountId`/`categoryId` correctly capped at `MAX_IDS = 50` but `years` has no such limit. [transactions/route.ts:148-157] *(iter8)*
- **M145**: `.in()` called with potentially empty arrays in 6+ routes — `accountIds` from user with no accounts produces `.in("account_id", [])`. Undocumented PostgREST behavior, version-dependent. Affected: transactions, ai/context, export/transactions, auto-detect, historical-spending (upCategoryIds), row-transactions (upCategoryIds). Correct guard exists in budget/summary and available-transactions but missing elsewhere. [transactions/route.ts:100, ai/context/route.ts:54, +4 more] *(iter8)*
- **M146**: Unvalidated `notification_preferences` JSONB — cron reads `timezone` and passes to `Intl.DateTimeFormat` without validation. `lead_days` accepted without bounds — `Number.MAX_SAFE_INTEGER` queries all future expenses. No server-side schema validation on profile's `notification_preferences` JSONB writes. [cron/notifications/route.ts:33-48, settings/notifications/page.tsx:206] *(iter8)*
- **M147**: `staleTimes.dynamic: 180` extends stale authorization window to 3 minutes in client Router Cache — 6x the default 30s. If partner revoked, stale RSC payload serves partnership data from cache. `revalidatePath()` only invalidates server cache, not client Router Cache. [next.config.ts:41] *(iter8)*
- **M148**: `ai_model` field accepts arbitrary strings with no model allowlist — only validates type (string) and length (1-100 chars). User can set model to deprecated/experimental models with weaker safety guardrails. System prompt with financial data and write-capable tools sent to arbitrary model identifiers. For OpenAI, could target fine-tuned models. [ai/settings/route.ts:51-67, ai/chat/route.ts] *(iter8)*
- **M149**: Server actions universally lack runtime Zod validation — 15 action files, 47+ exported functions accept TypeScript-typed parameters without runtime validation. ZERO server actions use Zod (vs API routes where 3/32 do per M26). Complex inputs like `createBudget` accept unbounded arrays (`initial_sections`, `hidden_item_ids`), unrestricted strings (`name`, `emoji`, `methodology`), and unvalidated enums (`budget_type`, `source_type`, `frequency`). Server actions are directly callable from client code with arbitrary payloads. Extends M26 to server actions layer. [all files in src/app/actions/] *(iter9)*
- **M150**: `updateInvestment` declares `asset_type: string` (line 78) while `createInvestment` correctly types as `"stock" | "etf" | "crypto" | "property" | "other"` (line 12). No runtime enum validation in either function, but the TypeScript inconsistency means `updateInvestment` doesn't even document valid values. Any arbitrary string accepted for asset_type update. [investments.ts:12,78] *(iter9)*
- **M151**: Cron endpoint externally callable — sole protection is `CRON_SECRET` Bearer token. Unlike Vercel's recommended `x-vercel-cron-signature` header verification, endpoint relies on user-configured secret. If `CRON_SECRET` weak/leaked/unset, entire endpoint (service role access to ALL profiles, AI key decryption, write-capable AI tools) exposed to Internet. Complements H4/H6 (what cron does) with how it's reached. [cron/notifications/route.ts:55-68, vercel.json:5-9] *(iter9)*
- **M152**: Demo mode defense-in-depth gaps — middleware blocks non-GET API mutations, but only 3 of 32 API routes have explicit demo guards. The 29 remaining mutating routes rely solely on middleware as single point of failure. If middleware matcher excludes an API path, mutations pass through. Comprehensive gap inventory extends L19/L20/M16. [middleware.ts:40-51, budget/shares/categories, budget/splits, +17 more routes] *(iter9)*
- **M153**: `NEXT_PUBLIC_DEMO_MODE` is client-exposed — `NEXT_PUBLIC_` prefix inlines value into client JS bundle. Any visitor to demo site can confirm it's a demo instance, learn that `DEMO_USER_EMAIL`/`DEMO_USER_PASSWORD` server-side secrets exist for auto-login, and see the frozen demo date (`2026-01-28T12:00:00`). [demo-guard.ts:7-9] *(iter9)*
- **M154**: `env.ts` validates only 5 of 11+ security-critical env vars — missing: `NEXT_PUBLIC_APP_URL` (CSRF), `DEMO_USER_EMAIL`/`DEMO_USER_PASSWORD` (demo auth), `NEXT_PUBLIC_DEMO_MODE`, `NEXT_PUBLIC_SKIP_LANDING`. `validateEnv()` also logs full error including env var names to console.error, visible in Vercel function logs. Extends L54. [env.ts:1-23] *(iter9)*
- **M155**: Server Supabase client silently swallows cookie set failures — empty catch block in `setAll` (line 26-29) hides auth refresh failures. If middleware not functioning, session refresh is invisible. Combined with M147 (3-min stale cache), extends invalid auth states. [utils/supabase/server.ts:26-29] *(iter9)*
- **M156**: Webhook uses only registrant's merchant rules for JOINT accounts — `userId` from `config.user_id` (webhook registrant). Partner B's merchant rules silently ignored even though both share the account. Transactions on joint accounts always get Partner A's categorization. [webhook/route.ts:467-472] *(iter9)*
- **M157**: Non-deterministic JOINT account lookup — `.limit(1).maybeSingle()` on duplicate `up_account_id` rows returns whichever Postgres returns first. Transaction could be upserted under different partner's account row on CREATED vs SETTLED events. `UNIQUE(account_id, up_transaction_id)` means same UP transaction creates TWO local rows. [webhook/route.ts:417-422] *(iter9)*
- **M158**: Weekly summary dedup uses UTC date but checks local day-of-week — for AEST users, UTC day boundary falls within their local day. If cron runs twice, dedup `gte` check on UTC midnight misses notification created before UTC midnight for the same local day. Creates duplicate AI-generated summaries. [cron/notifications/route.ts:200-207] *(iter9)*
- **M159**: Webhook `processTransactionDeletion` does not revert `next_due_date` advancement — matched transaction advances `next_due_date`, then UP Bank deletes transaction (merchant reversal). Expense match cleaned up but `next_due_date` stays advanced. Expense appears "upcoming" for wrong period. Extends L59 (user unmatch) to webhook-triggered deletion. [webhook/route.ts:616-656] *(iter9)*
- **M160**: `UNIQUE(transaction_id)` on `expense_matches` silently drops multi-expense matches — transaction matching multiple expenses (e.g., "NETFLIX" matching both "Netflix Standard" and "Netflix Premium") only matches first. `ignoreDuplicates: true` drops others without error. Losing expenses' `next_due_date` never advanced, appearing perpetually "due." [match-expense-transactions.ts:330-332] *(iter9)*
- **M161**: Sync route omits `is_shared` flag — webhook sets `is_shared: true` for JOINT accounts but sync route doesn't set it at all. Budget splitting logic behaves differently depending on whether transaction came from webhook or sync. [sync/route.ts:271-312 vs webhook/route.ts:540] *(iter9)*
- **M162**: Unknown `recurrence_type` causes infinite loop in `next_due_date` advancement — `calculateNextDueDate` has no `default` case in switch statement. Unrecognized type returns same date unchanged. `while (nextDue <= txnDate)` loop in matching code never terminates. Hangs webhook handler until timeout, blocks user's transaction processing. [budget-zero-calculations.ts:253-281, match-expense-transactions.ts:362-365] *(iter9)*
- **M163**: `income_sources` DELETE RLS policy allows partner to delete other partner's income records — policy uses triple-nested subquery allowing deletion of income sources belonging to ANY user in ANY partnership the caller belongs to. App code properly scopes to `user_id = user.id` but RLS is more permissive. Direct Supabase client calls (M114 client-only pages) bypass app-level scoping. [initial_schema.sql:1255] *(iter9)*
- **M164**: `transaction-overrides` POST upserts non-existent `created_by_user_id` and `category_name` columns — PostgREST silently ignores unknown columns, audit trail of override creator silently lost. [budget/transaction-overrides/route.ts:124-126] *(iter10)*
- **M165**: `merge_partnerships` does not validate `p_link_request_id` — function blindly marks any UUID as "accepted" without verifying request exists, is pending, or involves correct parties. Allows partnership merge without legitimate link request. [20260226_security_fixes.sql:103-169] *(iter10)*
- **M166**: Sync route loads ALL `transaction_category_overrides` globally without user scoping — builds in-memory Map from both partners' overrides, applies partner's overrides to user's transactions during category resolution. Unbounded memory for large partnerships. [sync/route.ts:161-169,263] *(iter10)*
- **M167**: `handle_new_profile` SECURITY DEFINER trigger C3 escalation — if attacker exploits C3 to join new user's (not-yet-created) partnership before trigger fires, trigger finds existing membership and returns early, denying victim their own partnership. Permanent DoS. [initial_schema.sql:45-73] *(iter10)*
- **M168**: `getVendorTransactionHistory` references non-existent `owner_id`/`partner_id` columns on `partnerships` table — PostgREST returns 400 error. Function always fails. Entire "match existing transactions" feature for expenses is non-functional. [expenses.ts:321,330] *(iter10)*
- **M169**: Non-SECURITY-DEFINER trigger functions inherit service role privileges — `invalidate_expense_match_on_recategorize` performs unscoped `DELETE FROM expense_matches` which, when triggered by service-role webhook updates, bypasses RLS entirely. [initial_schema.sql:95-106] *(iter10)*
- **M170**: `.or()` year filter logically broken for multi-year — two-condition pairs (gte+lt) are OR-flattened by PostgREST, not grouped as AND pairs. Selecting 2+ years matches ALL transactions instead of selected years. Affects both list and summary totals. [transactions/route.ts:148-156,272-280] *(iter10)*
- **M171**: AI `searchTransactions` `.or()` amount filters incorrect for negative amounts — `maxAmount` filter `.or("amount_cents.gte.-{max},amount_cents.lte.{max}")` matches nearly ALL transactions. AI financial summaries use incorrect transaction sets. [ai-tools.ts:155-156] *(iter10)*
- **M172**: Signup and forgot-password bypass server-side rate limiting — call `supabase.auth.signUp()`/`resetPasswordForEmail()` directly from browser client, skipping Next.js server and `RateLimiter`. Login correctly uses server action with rate limiter. Email enumeration and reset flooding possible. [signup/page.tsx:48, forgot-password/page.tsx:39] *(iter10)*
- **M173**: `/update-password` not in middleware `protectedPaths` — accessible to already-authenticated users as alternative password change path without recovery flow verification. Doesn't check session type. [middleware.ts:104, update-password/page.tsx] *(iter10)*
- **M174**: CSRF protection disabled when `NEXT_PUBLIC_APP_URL` unset — `if (appUrl && origin && ...)` skips entire check when env var missing. `.env.local.example` marks as "Recommended" not required. Distinct from M50 (null origin) and M71 (prefix bypass). [middleware.ts:98] *(iter10)*
- **M175**: `signOut()` uses default `scope: 'global'` — logout revokes ALL refresh tokens across ALL devices without consent. Combined with H30 (CSRF on signout), enables forced global logout via cross-site form POST. [auth/signout/route.ts:6] *(iter10)*
- **M176**: Confirm route `token_hash` in URL query parameters — exposed in server access logs, CDN logs, browser Referer header. OTP hash is single-use but log exposure creates pre-consumption replay window. [auth/confirm/route.ts:7-16] *(iter10)*
- **M177**: CSV export double-quote injection — `"${desc}"` wrapping doesn't escape `"` within values. Merchant name containing `"` breaks CSV structure per RFC 4180, enabling arbitrary cell injection. [export/transactions/route.ts:121] *(iter10)*
- **M178**: AI `queryFinancialData` ALLOWED_COLUMNS includes `card_number_suffix` (partial PAN) and `deep_link_url` (banking app URIs) — queryable via AI prompt injection, exposing PII and internal links. [ai-tools.ts:1247] *(iter10)*
- **M179**: `importLayout()` accepts arbitrary JSON without size/depth/schema limits — `JSON.parse()` on multi-MB string causes memory pressure. No section/column schema validation; arbitrary properties stored in database. [layout-persistence.ts:66-95] *(iter10)*
- **M180**: AI tools return raw Supabase `error.message` in 15+ locations — schema-revealing error messages (table/column/constraint names) as tool results. AI may relay verbatim to user despite system prompt instruction. [ai-tools.ts:159,1359,1989,2067,+11] *(iter10)*
- **M181**: `matchExpenseToTransactions` leaks Supabase error messages through API — `insertError.message` flows to rematch-all/backfill-all JSON `results` array. Schema details in HTTP response body. [match-expense-transactions.ts:171,268,337,498] *(iter10)*
- **M182**: User IDs logged in `console.error` in cron notification handler — PII (`profile.id`) alongside stack traces in unstructured Vercel logs, potentially shipped to third-party log aggregation. [cron/notifications/route.ts:161,278] *(iter10)*
- **M183**: Conflicting X-XSS-Protection header values — `next.config.ts` sets `0` (modern/correct), `vercel.json` sets `1; mode=block` (legacy). Both may be sent as comma-separated values causing unpredictable browser behavior. [next.config.ts:6, vercel.json:33] *(iter10)*
- **M184**: CSP missing explicit `object-src` and `worker-src` — defaults to `default-src 'self'`, allowing same-origin plugins and service worker registration. XSS + same-origin script could register persistent service worker. [next.config.ts:18-28] *(iter10)*
- **M185**: CSP `script-src 'unsafe-inline'` negates XSS protection — allows any inline `<script>` or event handler execution. Next.js supports nonce-based CSP as replacement. [next.config.ts:20] *(iter10)*
- **M186**: CI pipeline uses `npm ci` while project uses pnpm — `pnpm.overrides` security patches (6 CVE fixes documented in I10) completely ignored in CI. npm doesn't support pnpm overrides. [.github/workflows/ci.yml:19,31,48] *(iter10)*
- **M187**: Tool repair substring matching can route to unintended write tools — `experimental_repairToolCall` matches tool names bidirectionally via `includes()`. AI hallucinating `createSavingsGoalAndInvestment` matches `createSavingsGoal`. Model outputting `getAllTools` matches every tool name. Extends I26. [ai/chat/route.ts:263-291] *(iter11)*
- **M188**: AI write tool string inputs have no length limits — all `z.string()` parameters in 9 write tools lack `.max()`. `createBudget.name`, `createExpenseDefinition.name/notes`, `createSavingsGoal.name`, `createIncomeSource.name`, `createInvestment.name`, `updateInvestment.notes` — all unbounded. Prompt injection could write arbitrarily long strings. [ai-tools.ts:2136,2493,2581,2834,2923,3009] *(iter11)*
- **M189**: `updateSavingsGoal` can prematurely mark goal completed — `addFundsDollars` is `z.number().optional()` with no positive constraint. While negative values are ignored via `if (addFundsDollars > 0)`, combining `newTargetDollars` set to $0.01 with `newCurrent >= newTarget` check marks goal completed. [ai-tools.ts:2657,2690-2705] *(iter11)*
- **M190**: `annual_checkups.step_data` JSONB exposed to AI via `queryFinancialData` — `ALLOWED_COLUMNS` includes `step_data`, which contains sensitive financial planning data, retirement goals, and partner income details. AI may relay to user's chat. [ai-tools.ts:1267] *(iter11)*
- **M191**: 15-step limit allows up to 15 chained write operations per request — `stopWhen: stepCountIs(15)` combined with `toolChoice: "required"` on early steps. Prompt injection could cascade into 15 DB writes (budgets, goals, investments) before model produces text response. [ai/chat/route.ts:243,249] *(iter11)*
- **M192**: SETTLED event silently overwrites AI-assigned categories — when transaction transitions HELD→SETTLED, UP Bank category may change. If user has no override or merchant rule, SETTLED event's UP category replaces AI-assigned category from CREATED event permanently, with no notification. [webhook/route.ts:479-547] *(iter11)*
- **M193**: SETTLED fallback fabricates synthetic `settled_at` timestamp — when `fetchTransaction` fails for SETTLED event but HELD record exists, fallback sets `settled_at: new Date().toISOString()` using server clock instead of UP Bank's settlement time. Off by minutes/hours at month boundary, could place transaction in wrong budget period. Distinct from M51. [webhook/route.ts:744-755] *(iter11)*
- **M194**: Transaction description/raw_text/message stored without length validation — UP Bank fields stored directly as unbounded `text` with no CHECK constraints. Fields flow into AI categorization prompts, expense matching, merchant rule lookups, and client rendering. [webhook/route.ts:506-508, initial_schema.sql:309-311] *(iter11)*
- **M195**: Tag insertion loop unbounded — `txn.relationships.tags.data` iterated with no limit. Each tag produces two sequential DB upserts (tags + transaction_tags). Thousands of tags cause webhook timeout → UP Bank retries → infinite retry loop. [webhook/route.ts:555-571] *(iter11)*
- **M196**: Balance from UP Bank API trusted without type/bounds validation — `valueInBaseUnits` stored directly. No check for finite number, reasonable bounds, or expected currency. Corrupted balance propagates to goal completion checks, contribution delta calculations, and net worth snapshots. [webhook/route.ts:238-244] *(iter11)*
- **M197**: Net worth snapshot date computed in UTC — off-by-one day for Australian users — `new Date().toISOString().split("T")[0]` at 11pm AEST is stored as next day in UTC. User sees evening balance attributed to tomorrow. Distinct from M158 (cron dedup). [webhook/route.ts:369] *(iter11)*
- **M198**: Goal contribution insert not wrapped in DB transaction — goal balance update at line 284-289 and contribution insert at line 293 are separate operations. Failure between them creates inconsistent state: balance changed but no contribution recorded, or phantom contribution. Extends L63. [webhook/route.ts:284-300] *(iter11)*
- **M199**: `processTransaction` returns void on error — permanent transaction loss — account lookup or upsert errors at lines 427/551 return void. Caller receives no indication. Outer handler returns 200 OK. UP Bank won't retry. Transient errors silently drop transactions. [webhook/route.ts:424-427,549-552] *(iter11)*
- **M200**: Category override TOCTOU between read and upsert — override check at lines 479-498 reads before upsert at 500-547. User creating override between read and write gets overwritten by stale category. Override record exists but `transactions.category_id` no longer matches. [webhook/route.ts:479-498] *(iter11)*
- **M201**: `assigned_cents` accepts negative values via both Zod and DB — `z.number().int()` no min constraint, DB `bigint NOT NULL DEFAULT 0` no CHECK. TBB calculates `income + carryover - budgeted` — negative assignment reduces budgeted, inflating TBB. Extends M109 with TBB impact. [zero/assign/route.ts:44, initial_schema.sql:493] *(iter11)*
- **M202**: `parseMonthKey` timezone-dependent date parsing — `new Date(monthKey)` on date-only string behavior varies across environments. Budget engine uses `Date.UTC()` consistently but `budget-zero-calculations.ts` uses local timezone, creating potential mismatch between modules. [budget-zero-calculations.ts:74] *(iter11)*
- **M203**: Price API responses not validated for numeric range — neither `fetchCryptoPrice` nor `fetchYahooFinancePrice` validates returned price is positive finite number. Corrupt response (`null`, `NaN`, negative) flows directly into `valueCents`, corrupting `current_value_cents` and `investment_history`. Extends M55. [price-apis.ts:46-53,186-213] *(iter11)*
- **M204**: `refreshAllPrices` inner updates missing `partnership_id` scoping — initial query scoped by partnership_id but loop updates use only `.eq("id", inv.id)`. Inconsistent with `updateInvestmentPriceFromAPI` which includes both filters. Defense-in-depth gap. Extends M74. [investments.ts:360-363,385-388] *(iter11)*
- **M205**: Investment `quantity` field not validated — `createInvestment` and `updateInvestment` validate monetary cents but not `quantity`. Negative quantity produces negative `valueCents` in price refresh, corrupting `current_value_cents` and `investment_history`. [investments.ts:15,50,80,125] *(iter11)*
- **M206**: ReactMarkdown renders AI-generated href without protocol allowlist — `ChatMarkdown` component passes `href` directly to `<a>` element without `rehype-sanitize` configuration. AI-generated `javascript:` URIs could execute. Defense-in-depth gap. Extends M70. [piggy-chat.tsx:115-125] *(iter11)*
- **M207**: Expense modal `partnershipId` in URL without UUID validation — `partnershipId` prop interpolated directly into fetch URL. Malformed value containing URL-encoded characters could inject additional query parameters. Same pattern at lines 289, 301, 308. [expense-definition-modal.tsx:176,289,301] *(iter11)*
- **M208**: `parseFloat` NaN flows to database in 6 components — `Math.round(parseFloat(amount) * 100)` without NaN check in expense-definition-modal, invest-edit-client, invest/add/page, add-income-manual, add-income-oneoff, expense-from-transaction. HTML5 validation bypassable. [expense-definition-modal.tsx:240, +5 files] *(iter11)*
- **M209**: Budget analysis unencoded slugs from user-controllable category names — `navigateToCategory` uses `.replace()` but misses `#`, `?`, `%`, `/`. Contrast: `navigateToIncomeSource` correctly uses `encodeURIComponent()`. Malformed URLs or parameter injection possible. [budget-analysis-dashboard.tsx:177-186] *(iter11)*
- **M210**: Security page password change UI removed current password field entirely — `currentPassword` state declared but input field removed from form. `handleChangePassword` calls `updateUser({ password })` without re-authentication. State variable is dead code. Extends H9. [settings/security/page.tsx:33-79] *(iter11)*
- **M211**: `getTopMerchants` and `getDailySpending` unbounded all-time queries — `getTopMerchants` with month omitted queries all transactions across all time. Aggregation caps output but underlying query loads tens of thousands of rows into memory. Same pattern in `getDailySpending` and `getMonthlyTrends`. [ai-tools.ts:712-752,1076-1135] *(iter11)*
- **M212**: Invest add page silently ignores search params — watchlist generates links with pre-filled `?name=...&ticker=...&type=...` but `AddInvestmentPage` never reads `useSearchParams()`. If consumed in future without validation, phishing vector via crafted URLs. [invest/add/page.tsx:34-44, invest-client.tsx:770] *(iter11)*
- **M213**: `target_allocations.target_percentage` no CHECK constraint ensuring valid range or sum=100% — accepts any numeric value. `calculateRebalancing` uses directly. 200% or -50% produces nonsensical recommendations. Extends L69 with rebalancing impact. [initial_schema.sql:714-722, portfolio-aggregation.ts:240] *(iter11)*
- **M214**: `investment_history` has no DELETE or UPDATE RLS policy — corrupted prices from M203 stored in history cannot be corrected by authenticated user. If code extended to update/delete, operations silently fail. Extends M58 with operational impact. [initial_schema.sql:1263-1264] *(iter11)*
- **M215**: `net_worth_snapshots` missing UPDATE RLS causes silent update failure — `upsertInvestmentNetWorth` attempts `.update()` but no UPDATE policy exists. Repeated price refreshes don't update today's snapshot, causing stale investment totals. Extends M39 with operational consequence. [initial_schema.sql:1298-1299, net-worth-helpers.ts:33-35] *(iter11)*
- **M216**: `updateGoal` allows `target_amount_cents` zero or negative — no validation on financial fields. Zero target causes division-by-zero in milestone check (`oldAmountCents / targetAmountCents`). Negative values corrupt percentage calculations. Extends M46. [goals.ts:261-306] *(iter11)*
- **M217**: `logInvestmentContribution` accepts arbitrary `contributedAt` date — raw string passed to DB without validation. Far-future, 1970 dates, or invalid strings accepted. Backdated contribution inflates budget summary for past periods. Extends L76. [investments.ts:267-311] *(iter11)*
- **M218**: Cron job loads all user `ai_api_key` values into memory regardless of summary enablement — all profiles including encrypted keys loaded from Supabase. Only users with summaries enabled need decryption. Unnecessary memory exposure. Extends M21. [cron/notifications/route.ts:172-178] *(iter11)*
- **M219**: `window.confirm()` for destructive delete operations — investment delete and bank disconnect use synchronous `window.confirm()`, bypassable via programmatic calls or browser extensions. Account deletion correctly uses typed confirmation requiring "DELETE" text. Inconsistent protection. [invest-edit-client.tsx:103, up-connection/page.tsx:205] *(iter11)*
- **M220**: Layout API POST creates preset in foreign partnership — user_id verified as self but partnership_id membership unchecked. RLS policies check `user_id = auth.uid()` which passes since user inserts with own user_id. Creates layout data in foreign partnership. Extends M27/M28 with RLS bypass analysis. [budget/layout/route.ts:109-212, templates/route.ts:115] *(iter11)*
- **M221**: Budget summary endpoint fetches all columns before authorization — initial `.select("*")` on `user_budgets` returns metadata (`methodology`, `total_budget`, `category_filter`) before partnership check. Budget metadata in server memory before auth verification. Extends M107. [budget/summary/route.ts:59-75] *(iter11)*

### LOW (169)

- **L1**: LIKE metachar injection in search (fixed in transactions, but legacy match_pattern unfixed) [multiple]
- **L2**: Cron secret timing comparison has length oracle [cron/notifications/route.ts:57]
- **L3**: CSP img-src allows all HTTPS sources [next.config.ts:23]
- **L4**: X-XSS-Protection inconsistency between next.config.ts (0) and vercel.json (1; mode=block) [both files]
- **L5**: Duplicate security headers in vercel.json and next.config.ts [both files]
- **L6**: pnpm-lock.yaml not committed to git [pnpm-lock.yaml]
- **L7**: Dockerfile uses npm ci but project uses pnpm [Dockerfile:12]
- **L8**: 120+ console.error calls may log sensitive data to server logs [73 files]
- **L9**: 30+ 'as any' type assertions in production code bypass type safety [multiple files]
- **L10**: Webhook logs potentially sensitive transaction IDs [webhook/route.ts:757]
- **L11**: Cron handler fetches all profiles without pagination [cron/notifications/route.ts:77]
- **L12**: Service role client cached as module-level singleton [service-role.ts:10]
- **L13**: isEncrypted() check can be fooled by crafted colon-separated hex strings [token-encryption.ts:75]
- **L14**: AI API keys encrypted with same key as bank tokens — single key compromise exposes all [ai/settings/route.ts:80]
- **L15**: AI chat allows 100 messages x 50KB each = 5MB per request [ai/chat/route.ts:18]
- **L16**: AI tool repair mechanism uses substring matching — could redirect to wrong tools [ai/chat/route.ts:263]
- **L17**: Export endpoint has no row limit — full history extractable in one request [export/transactions/route.ts:52]
- **L18**: Markdown export doesn't sanitize merchant names for markdown injection [export/transactions/route.ts:200]
- **L19**: Expense creation POST missing demo mode guard [budget/expenses/route.ts:84]
- **L20**: Expense PATCH/DELETE missing demo mode guard [budget/expenses/[id]/route.ts:8]
- **L21**: Historical spending months parameter not bounded [budget/historical-spending/route.ts:38]
- **L22**: Custom categories array not length-limited [budget/methodology/customize/route.ts:138]
- **L23**: Methodology POST doesn't validate methodology value against allowlist [budget/methodology/route.ts:54]
- **L24**: Goal contribution recording is fire-and-forget — can lose records [goals.ts:110]
- **L25**: Notifications PATCH body not validated — notification_ids not checked as UUIDs [notifications/route.ts:79]
- **L26**: Profile settings page `select("*")` from client component sends encrypted AI keys to browser. [settings/profile/page.tsx:47] *(iter2)*
- **L27**: Avatar URL accepts arbitrary user input without server-side validation — stored directly in DB. [settings/profile/page.tsx:76] *(iter2)*
- **L28**: `/dev/accent-picker` page accessible to all authenticated users in production — no admin/dev guard. [dev/accent-picker/page.tsx] *(iter2)*
- **L29**: CRON_SECRET required in env.ts validation schema but MEMORY.md says "removed entirely" — inconsistency signals confusion about endpoint's existence. [env.ts:11] *(iter2)*
- **L30**: Forgot-password page leaks email validity via Supabase response behavior differences for registered vs unregistered emails. [forgot-password/page.tsx:39] *(iter2)*
- **L31**: Null-unsafe `user?.id` in server page queries — if auth check passes but user is null, `undefined` passed as filter value. [invest/[id]/page.tsx:35, goals/[id]/page.tsx:43] *(iter2)*
- **L32**: Signout endpoint accepts POST without CSRF token — cross-site attacker could force logout. [auth/signout/route.ts] *(iter2)*
- **L33**: Route params decoded via `decodeURIComponent()` and rendered in headings — safe via React escaping but fragile pattern. [activity/merchant/[merchant]/page.tsx:30] *(iter2)*
- **L34**: No audit logging for budget sharing configuration changes — partner can silently shift share percentages. [shares/categories/route.ts:97] *(iter2)*
- **L35**: Bulk merchant recategorization has no upper bound on affected transactions — common merchant could recategorize thousands. [recategorize/route.ts:197] *(iter2)*
- **L36**: `completeCheckup` accepts arbitrary `actionItems` array without length/content validation. [checkup.ts:106] *(iter2)*
- **L37**: `markGoalComplete` allows marking underfunded goals as complete without verifying progress. [goals.ts:140] *(iter2)*
- **L38**: CSV export doesn't strip newline characters from transaction descriptions — could inject additional CSV rows. [export/transactions/route.ts:96] *(iter2)*
- **L39**: Manual partner `super_balance_cents` and `super_contribution_rate` accept negative/extreme values without validation. [partner.ts:24] *(iter2)*
- **L40**: Rate limiter `cleanup()` method defined but never called — Map grows unbounded in warm instances. [rate-limiter.ts:81] *(iter2)*
- **L41**: `partnerships` table INSERT policy `WITH CHECK (true)` allows unlimited partnership creation by any user. [initial_schema.sql:1318] *(iter2)*
- **L42**: FIRE `runProjection` has no input bounds on growth rates — extreme values cause Infinity/NaN overflow. [fire-calculations.ts:612] *(iter2)*
- **L43**: `updateGoal` accepts arbitrary `icon`/`color` strings without format/length validation. [goals.ts:261] *(iter2)*
- **L44**: No persistent security event logging to file or database — `console.error` only, lost on serverless cold restart. Audit trail for security incidents nonexistent. [entire codebase] *(iter3)*
- **L45**: No security alerting mechanism — failed auth attempts, rate limit hits, unusual access patterns not surfaced or notified. [entire codebase] *(iter3)*
- **L46**: Notification mark-as-read fires PATCH without `.catch()` — network failures cause UI to show "0 unread" while server still has unread. State update before server confirmation. [notification-bell.tsx:94-103] *(iter3)*
- **L47**: Profile page `useEffect` with empty deps creates async function that updates state after unmount — no cleanup guard. [settings/profile/page.tsx:38-61] *(iter3)*
- **L48**: Theme provider reads `localStorage.getItem("piggyback-theme")` and applies directly as CSS class via `classList.add()` — tampered localStorage injects arbitrary class name on document root. CSS injection vector. [theme-provider.tsx:13] *(iter3)*
- **L49**: Up-connection page `useEffect` calls `checkConnection()` not listed as dependency — stale closure risk if component re-renders before effect. [settings/up-connection/page.tsx:62-64] *(iter3)*
- **L50**: Notification bell `eslint-disable-next-line react-hooks/exhaustive-deps` suppresses warning — effect reads stale `notifications` state when `open` changes. [notification-bell.tsx:107-108] *(iter3)*
- **L51**: Formula evaluator logs `console.error('Formula evaluation error:', error, 'Formula:', formula)` — leaks user financial amounts from evaluated expressions to server logs. [formula-evaluator.ts:328] *(iter3)*
- **L52**: Appearance page `loadTheme` returns early if localStorage has theme without checking server preference — multi-device theme desync. [settings/appearance/page.tsx:71-78] *(iter3)*
- **L53**: Auth callback `next` param check allows backslash (`/\evil.com`) — some browsers interpret `\` as `/`, creating open redirect. Also doesn't validate against app's own routes. [auth/callback/route.ts:7-8] *(iter4)*
- **L54**: `validateEnv` does not validate `NEXT_PUBLIC_APP_URL` — if missing, CSRF protection in middleware is completely disabled (M50 depends on it). Other security-relevant env vars also unvalidated. [env.ts:1-23] *(iter4)*
- **L55**: `signIn` rate limiter keys on `email.toLowerCase()` not IP — attacker knowing user's email can lock them out with 5 failed attempts. Enables targeted account lockout DoS. [auth.ts:6-16] *(iter4)*
- **L56**: Cookie security attributes rely on Supabase library defaults — no explicit Secure/HttpOnly/SameSite configuration in application code. [utils/supabase/*] *(iter5)*
- **L57**: Export endpoint missing `X-Content-Type-Options: nosniff` header — browser could MIME-sniff CSV as HTML. [export/transactions/route.ts] *(iter5)*
- **L58**: Transaction API negative offset values not guarded — `parseInt(offset)` accepts negative numbers, producing unexpected Supabase `.range()` behavior. [transactions/route.ts:13] *(iter5)*
- **L59**: Expense unmatch (DELETE) does not rollback `next_due_date` — repeated match/unmatch of same transaction advances due date arbitrarily far into future, hiding expense from upcoming bills. [budget/expenses/match/route.ts:106-172] *(iter5)*
- **L60**: Webhook `updateAccountBalance` goal balance updates via service role lack cross-partnership guard. If two partnerships share same `up_account_id` (possible after merge bugs), webhook updates goals in both. [webhook/route.ts:231-401] *(iter5)*
- **L61**: AI `queryFinancialData` adds `.eq("partnership_id", ...)` filter to `expense_matches` but that table has no `partnership_id` column — query silently errors, falling back to RLS-only protection. [ai-tools.ts:1298-1306] *(iter5)*
- **L62**: Budget layout context sends `userId` in client-side query parameters — UUID exposed in browser network tab, server logs, CDN logs. Enables IDOR if any endpoint trusts user_id param over session. [budget-layout-context.tsx:98-162] *(iter5)*
- **L63**: Goal contribution `.insert()` in webhook handler has no deduplication key — webhook retries create duplicate contribution records, corrupting savings progress chart. [webhook/route.ts:292-299] *(iter5)*
- **L64**: `budgets` table missing DELETE RLS policy — budget records cannot be deleted via client. [initial_schema.sql:1221-1223] *(iter5)*
- **L65**: `partnerships` table missing DELETE RLS policy — partnerships undeletable even by owner. [initial_schema.sql:1316-1318] *(iter5)*
- **L66**: `partner_link_requests` missing DELETE RLS policy — users cannot cancel/withdraw pending link requests. [initial_schema.sql:1307-1309] *(iter5)*
- **L67**: `transaction_references` missing UPDATE RLS policy. [initial_schema.sql:1354-1357] *(iter5)*
- **L68**: `investment_contributions` missing UPDATE RLS policy — contribution records must be deleted and recreated to correct errors. [initial_schema.sql:1267-1269] *(iter5)*
- **L69**: `target_allocations.target_percentage` has no CHECK constraint — accepts any numeric value including negative. No constraint ensuring sum = 100%. [initial_schema.sql:719] *(iter5)*
- **L70**: `couple_split_settings.owner_percentage` nullable and unconstrained — NULL when `split_type = 'percentage'` causes division errors. [initial_schema.sql:631] *(iter5)*
- **L71**: No index on `transactions.settled_at` — budget spending queries filter by `settled_at` date range, causing full table scans. DoS potential for users with large transaction history. [initial_schema.sql:1088-1101] *(iter5)*
- **L72**: `toggleGoalChecklistItem` itemIndex not validated as non-negative integer — `0.5` or `NaN` passes bounds check but produces undefined behavior. [goals.ts:324-370] *(iter6)*
- **L73**: `removeManualPartner` income source soft-delete error silently ignored — partner removed but orphaned income sources remain active. [partner.ts:103-107] *(iter6)*
- **L74**: `completeOnboarding` DB update error not checked — function completes silently on failure. [onboarding.ts:12-19] *(iter6)*
- **L75**: `updateFireProfile` `date_of_birth` not validated as valid date format — malformed date strings stored directly. [fire.ts:9] *(iter6)*
- **L76**: `logInvestmentContribution` `contributedAt` date not validated before DB insert. [investments.ts:270,309] *(iter6)*
- **L77**: No concurrent session limit or tracking — unlimited simultaneous logins, no "log out all devices" feature. Compromised credentials allow parallel persistent sessions. [utils/supabase/*] *(iter6)*
- **L78**: Missing `Cross-Origin-Resource-Policy` header — app resources embeddable by any cross-origin page. [next.config.ts, vercel.json] *(iter6)*
- **L79**: Missing `Cross-Origin-Embedder-Policy` and `Cross-Origin-Opener-Policy` headers — no cross-origin isolation, window handle accessible to opener/opened pages. [next.config.ts, vercel.json] *(iter6)*
- **L80**: External API custom `User-Agent: PiggyBack/1.0` reveals app identity; ticker symbols sent to Yahoo Finance/CoinGecko reveal user portfolio to network observers. [price-apis.ts:143-174] *(iter6)*
- **L81**: Plaintext UP Bank API token held in serverless function memory for up to 5 minutes during sync — memory dumps expose token. No clearing mechanism. [sync/route.ts:54-64] *(iter6)*
- **L82**: Budget splits DELETE fetches setting by ID before partnership check — UUID enumeration via 404 vs 403 distinction. [budget/splits/route.ts:156-160] *(iter6)*
- **L83**: `ConnectionStatusContext` returns all-true defaults (`hasAccounts`, `hasGoals`, `hasPayday`, `fireOnboarded`, etc.) when used outside provider — components accidentally rendering outside `(app)` layout show all features as available, potentially confusing UI state. [connection-status-context.tsx:37-41] *(iter6)*
- **L84**: FIRE `calculateSavingsImpact()` double-counts reduced spending — reducing spending simultaneously increases savings AND reduces FIRE target (expenses * 25). Extra savings > current spending produces negative FIRE target, tool falsely reports FIRE achieved. No upper bound validation. [fire-calculations.ts:333-374] *(iter7)*
- **L85**: Portfolio history forward-fill uses current prices as fallback for investments without early history records — `lastKnown.set(inv.id, inv.current_value_cents)` injects today's value at chart start, making portfolio appear flat/declining when it actually grew. [portfolio-aggregation.ts:141-143] *(iter7)*
- **L86**: Annualized return produces NaN for investments with > 100% loss over > 1 year — `Math.pow(negative_base, fractional_exponent)` returns NaN. Also produces extreme values for short holding periods. NaN propagates to UI. [invest-calculations.ts:150-169] *(iter7)*
- **L87**: Expense matcher division by zero when `expected_amount_cents` is 0 — `amountDiffPercent = amountDiff / 0` produces Infinity. Zero-amount expense can match any transaction via pattern/timing score alone, creating false matches. [expense-matcher.ts:74-91] *(iter7)*
- **L88**: `countOccurrencesInPeriod` uses `<=` end boundary — potential double-counting of monthly expenses at period boundaries in fortnightly/weekly budget views when period end extends to midnight of next day. [budget-engine.ts:314-383] *(iter7)*
- **L89**: Rebalancing calculator accepts unbounded/negative target percentages — no validation that allocations sum to 100%. Targets > 100% suggest buying everything; targets < 100% suggest selling everything; negative targets invert buy/sell signals. [portfolio-aggregation.ts:240-275] *(iter7)*
- **L90**: `private.get_partner_user_ids` SECURITY DEFINER returns ALL users from ALL partnerships the caller belongs to — if user is member of multiple partnerships (schema allows it), function returns user IDs from both. Used in accounts, transactions, and transaction_notes SELECT RLS. [initial_schema.sql:801-811] *(iter7)*
- **L91**: `private.get_user_partnerships` SECURITY DEFINER accepts arbitrary `user_uuid` parameter — not limited to `auth.uid()`. Currently called safely from RLS with `auth.uid()`, but function signature permits misuse if called from other contexts. [initial_schema.sql:813-822] *(iter7)*
- **L92**: `transaction_tags` missing UPDATE RLS policy (in addition to DELETE, documented in M59) — tag names cannot be corrected, only deleted and recreated. [initial_schema.sql:1366-1367] *(iter7)*
- **L93**: `user_dashboard_charts` RLS scoped by `user_id` but `category_filter` may reference partnership-scoped category IDs — charts survive partnership departure, creating orphaned configurations referencing stale data. [initial_schema.sql:1389-1392] *(iter7)*
- **L94**: `income_sources` RLS policies use triple-nested subquery pattern — `user_id IN (SELECT pm.user_id FROM partnership_members pm WHERE pm.partnership_id IN (SELECT ... WHERE ... = auth.uid()))` executes for every row access. O(rows * partnerships) performance concern for large datasets. [initial_schema.sql:1255-1260] *(iter7)*
- **L95**: `profiles` table has no INSERT RLS policy — relies entirely on `handle_new_user` SECURITY DEFINER trigger for profile creation. Client-side `.insert()` blocked by default-deny. Correct behavior but undocumented — any future code must use auth trigger path. [initial_schema.sql:1321-1322] *(iter7)*
- **L96**: `handle_new_user` trigger extracts `display_name` from `raw_user_meta_data` without sanitization — crafted display_name via `signUp({ data: { display_name: "..." } })` stored directly. React escaping prevents XSS on render, but stored malicious strings could exploit email notifications, CSV exports, or AI prompts. [initial_schema.sql:32-43] *(iter7)*
- **L97**: CSV export does not escape double-quote characters within descriptions (RFC 4180 requires `"` → `""`). Transaction descriptions from UP Bank containing `"` break CSV field boundaries, corrupting export structure. Distinct from M84 (formula injection) and L38 (newlines). [export/transactions/route.ts:118-121] *(iter7)*
- **L98**: `calculatePercentage` produces values > 100% or negative when inputs are negative — progress bars/charts may overflow or render incorrectly. With both `spent` and `assigned` negative (possible via M109), percentage appears positive, masking abnormal state. [budget-zero-calculations.ts:118-121] *(iter7)*
- **L99**: AI-generated weekly summary notification content not length-bounded or content-validated — AI text stored directly in `notifications.message`. Could contain extremely long strings, zero-width characters, or prompt-injected merchant names that visually pollute the UI. React prevents XSS but content is uncontrolled. [cron/notifications/route.ts:264-275] *(iter7)*
- **L100**: Budget slug collision race — two concurrent `createBudget`/`duplicateBudget` calls with same name both check existing slugs, both see base slug available, both insert identical slug. No unique constraint on `(partnership_id, slug, is_active)`. Breaks URL routing. [slugify.ts:39-70] *(iter8)*
- **L101**: `saveCheckupStep` non-atomic JSONB merge race — reads `step_data`, merges step in-memory, writes whole object. Partners simultaneously saving different steps — second write overwrites first partner's step data. [checkup.ts:74-97] *(iter8)*
- **L102**: `startOrResumeCheckup` duplicate creation race — checks for existing checkup then creates if not found. Two simultaneous calls both see no existing row and both insert, creating duplicate checkup rows for same `(partnership_id, financial_year)`. No unique constraint. [checkup.ts:30-51] *(iter8)*
- **L103**: `DropdownMenuItem` goal actions no disable guard — `handleMarkComplete`/`handleReopenGoal` set loading state internally but menu items never get `disabled={loading}`. Rapid clicks fire multiple concurrent server action calls and duplicate milestone notifications. [goal-actions-menu.tsx:126-133] *(iter8)*
- **L104**: AI chat `new Response("Unauthorized", { status: 401 })` returns plain text while all other routes return `NextResponse.json()`. Inconsistent content types confuse client error handling. [ai/chat/route.ts:48] *(iter8)*
- **L105**: `Object.fromEntries(searchParams.entries())` silently drops duplicate query parameters — keeps only last value for each key. Used in `row-transactions` and `historical-spending` GET handlers before Zod parse. [row-transactions/route.ts:26, historical-spending/route.ts:25] *(iter8)*
- **L106**: Notification action uses `.single()` instead of `.maybeSingle()` — throws PGRST116 for zero rows, mixing "not found" with query errors. `id` path param also not validated as UUID. [notifications/[id]/action/route.ts:48-53] *(iter8)*
- **L107**: Export route uses TypeScript `as` type assertion instead of Zod validation — `format` could be any string (not just "csv"/"markdown"), `dateFrom`/`dateTo` passed unvalidated to `.gte()`/`.lte()` filters. Inconsistent with rest of codebase using `parseBody()`. [export/transactions/route.ts:24-35] *(iter8)*
- **L108**: `updateFireProfile` numeric fields unbounded — `super_contribution_rate`, `expected_return_rate`, `income_growth_rate` accept any finite number (e.g., 100000% or -50%). `target_retirement_age` has no check at all (could be 0 or 999). `Number.isFinite()` prevents NaN/Infinity but no min/max. [fire.ts:8-90] *(iter9)*
- **L109**: `connectUpBank` `plaintextToken` has no length validation — extremely long string (megabytes) passed to `fetch()` as Authorization header. Should have reasonable max length (~500 chars). [upbank.ts:272] *(iter9)*
- **L110**: Notifications GET `limit` NaN pass-through — `Math.min(parseInt("abc"), 50)` = NaN. `parseInt` of non-numeric string returns NaN, `Math.min(NaN, 50)` = NaN. Passed to `.limit(NaN)` producing undefined Supabase behavior. [notifications/route.ts:27] *(iter9)*
- **L111**: `markTransactionAsIncome` `incomeType` has no validation — arbitrary string with no length limit passed directly to database update. [transactions.ts:8-69] *(iter9)*
- **L112**: Cron endpoint uses GET for side-effecting operations — creates notifications, executes AI models, decrypts API keys. GET semantics imply idempotent/safe. Browser prefetch, crawlers, proxy cache warming could trigger the endpoint. URL with Bearer token logged in access logs. [cron/notifications/route.ts:55] *(iter9)*
- **L113**: `global-error.tsx` receives full Error object but does not log it — unlike 8 per-route error.tsx files that call `console.error(error)` (M69), the global error boundary silently drops the error. Critical failures at root layout level are invisible. [global-error.tsx:1-83] *(iter9)*
- **L114**: Per-request `supabase.auth.getUser()` + profiles query with no timeout — middleware makes 2 round-trips to Supabase on every request. Supabase latency spike or outage hangs entire application. No `AbortController` or caching layer. [middleware.ts:66-68,136-148] *(iter9)*
- **L115**: Demo mode auto-login credentials held in middleware memory — `signInWithPassword({ email: demoEmail, password: demoPassword })` called for every unauthenticated request in demo mode. If middleware throws post-auth, stack trace may contain credentials. [middleware.ts:71-82] *(iter9)*
- **L116**: Single-region deployment (`syd1`) with cross-region DB — Vercel functions in Sydney, Supabase in `ap-northeast-1` (Tokyo). ~60-100ms cross-region latency on every DB query, compounding with L114's per-request auth checks. No failover region. [vercel.json:4] *(iter9)*
- **L117**: AI API key input field missing `autocomplete="off"` — uses raw `<input>` element (not `<Input>` component), browser may offer to save API key in password manager. [ai-settings.tsx:167-186] *(iter9)*
- **L118**: Password change form uses wrong autocomplete annotation — `<Input>` component auto-sets `autoComplete="current-password"` but new-password fields should use `autoComplete="new-password"`. Password managers may autofill current password into new field. [settings/security/page.tsx:152,174] *(iter9)*
- **L119**: `financialContext` fetched to client but never used — `/api/ai/context` returns full financial summary (balance, income, spending, transactions, bills, goals). `PiggyChatWrapper` fetches and passes as prop. `PiggyChat` destructures only `hasApiKey`, never references `financialContext`. Unnecessary data exposure in React state. [piggy-chat-wrapper.tsx:13-18, piggy-chat.tsx:59,302-304] *(iter9)*
- **L120**: Sync route omits `performing_customer` field — webhook sets `performing_customer: txn.attributes.performingCustomer?.displayName` but sync route omits it entirely. For joint accounts, lose information about which partner made the purchase. [sync/route.ts:271-312] *(iter9)*
- **L121**: AI categorization fire-and-forget has no rate limiting — `aiCategorizeTransaction().catch(...)` called for every uncategorized webhook transaction. Rapid webhook bursts fire many concurrent AI API calls. No queuing, batching, or rate limiting. [webhook/route.ts:593-608] *(iter9)*
- **L122**: Double `updateAccountBalance` for transfer transactions — source AND destination accounts updated per webhook, and UP Bank sends webhooks for BOTH sides. Total: 4 balance updates + 4 net worth snapshot calculations for a single transfer. [webhook/route.ts:434-439] *(iter9)*
- **L123**: `profiles` SELECT RLS prevents partner profile visibility — `auth.uid() = id` policy means Partner A cannot read Partner B's `display_name`/`avatar_url`. Shared UX features showing partner info must use service-role or alternative data paths. [initial_schema.sql:1321-1322] *(iter9)*
- **L124**: `methodology_customizations` partnership-wide records unmanageable after owner leaves — FOR ALL policy restricts shared customizations (`user_id IS NULL`) to `role = 'owner'`. After `merge_partnerships`, joining user gets 'member' role. No role promotion mechanism exists, so remaining partner cannot modify shared methodology settings. [initial_schema.sql:1288] *(iter9)*
- **L125**: `budget_layout_presets` RLS policies user-only scoped — security fix correctly adds RLS but all 4 policies use `user_id = auth.uid()`. Template layouts invisible to partner despite `partnership_id` column. Overly restrictive, not permissive. [20260226_security_fixes.sql:14-28] *(iter10)*
- **L126**: ON DELETE CASCADE from `investments`/`savings_goals` to `budget_assignments` destroys budget history — deleting investment or completed goal cascade-deletes all budget assignment records across multiple months. [initial_schema.sql:915,918] *(iter10)*
- **L127**: `handle_updated_at` trigger overwrites explicit application timestamps — webhook sets `updated_at` in payload but trigger overrides with `timezone('utc', now())`. Fires on no-change updates, creating false recency signals for "last synced" display. [initial_schema.sql:22-30,1404] *(iter10)*
- **L128**: `income_sources.amount_cents` is `integer` (32-bit) not `bigint` — inconsistent with all other monetary columns. Caps at ~$21.4M. Silent overflow in sum operations. Extends I32 (same issue on different table). [initial_schema.sql:576] *(iter10)*
- **L129**: No index on `expense_matches.for_period` — budget expense projections filter by period date ranges requiring sequential scans. Compounds with triple-nested RLS policy on this table. [initial_schema.sql:614-622,1088] *(iter10)*
- **L130**: Password change does not invalidate existing sessions — `updateUser({ password })` succeeds but no `signOut({ scope: 'others' })` called. Compromised sessions remain valid until token expiry. Extends H9. [settings/security/page.tsx:63-79] *(iter10)*
- **L131**: `/update-password` renders form without session verification — no check for valid session or recovery flow before showing password change form. Already-logged-in users get alternative password change path. [update-password/page.tsx:9-45] *(iter10)*
- **L132**: Middleware makes `profiles` query on every protected request — `has_onboarded` check adds database round-trip per navigation, not cached. Supabase latency spike blocks all page loads. Extends L114. [middleware.ts:136-148] *(iter10)*
- **L133**: Markdown export no sanitization for markdown special chars — pipe `|`, backtick, link syntax `[]()` in merchant names break table formatting or inject clickable links in markdown viewers. [export/transactions/route.ts:199-207] *(iter10)*
- **L134**: CSV export missing UTF-8 BOM — Excel on Windows defaults to ANSI encoding without BOM. Non-ASCII chars in merchant names display garbled. `Content-Type` lacks `charset=utf-8`. [export/transactions/route.ts:125-133] *(iter10)*
- **L135**: Export `dateFrom`/`dateTo` not validated — arbitrary strings passed to Supabase `.gte()`/`.lte()`. No check for valid ISO dates, reasonable range, or from-before-to ordering. [export/transactions/route.ts:29-35,61-62] *(iter10)*
- **L136**: AI context route `/api/ai/context` returns full financial summary without rate limiting — total balances, income, spending by category, 15 transactions, bills, goals in single GET. No `chatLimiter`. [ai/context/route.ts:1-188] *(iter10)*
- **L137**: Fragile error chain — server actions embed `error.message` in `throw new Error()` before outer `safeErrorMessage` catches. Pattern survives currently but risks schema leak if error handling changes. [expenses.ts:55, budgets.ts:192,295] *(iter10)*
- **L138**: Missing error boundaries for `/notifications` and `/analysis` routes — errors bubble to parent `(app)/error.tsx`. `/analysis` is data-heavy SSR page likely to encounter errors. [notifications/, analysis/] *(iter10)*
- **L139**: 40+ `console.error` calls in API routes log full Supabase `PostgrestError` objects — `message`, `details`, `hint`, `code` fields reveal schema. `safeErrorMessage` used in server actions but not API routes. [webhook/route.ts, sync/route.ts, +30 more] *(iter10)*
- **L140**: Inconsistent `safeErrorMessage` usage — server actions use centralized sanitization, API routes use manual `console.error` + generic message pattern. No `[SafeError]` prefix in API route logs. [all actions vs all API routes] *(iter10)*
- **L141**: Formula evaluator logs substituted formula with actual financial values on error — `console.error('Formula:', formula)` where formula has replaced placeholders (e.g., `10000 - 5000`). [formula-evaluator.ts:328] *(iter10)*
- **L142**: Up Bank webhook registration forwards raw API error detail — `errorData.errors?.[0]?.detail` from third-party response returned directly to client without sanitization. [upbank.ts:100-103] *(iter10)*
- **L143**: Silently swallowed errors — empty `if (refError) { }` in expenses.ts:146, tag upsert errors in webhook:556, category upsert in sync:86. Operational issues go undetected. [expenses.ts:146, webhook/route.ts:556, sync/route.ts:86] *(iter10)*
- **L144**: CSP `img-src` allows all HTTPS sources — `img-src 'self' data: blob: https:` enables pixel tracking from any domain and content spoofing via injected `<img>` tags. [next.config.ts:23] *(iter10)*
- **L145**: Duplicate security headers in both `vercel.json` and `next.config.ts` — maintenance drift risk, already demonstrated by M183 X-XSS-Protection conflict. [next.config.ts:3-30, vercel.json:22-53] *(iter10)*
- **L146**: `.mcp.json` uses unpinned `npx shadcn@latest` in git-tracked file — supply chain risk for developers cloning repo. Compromised npm package executes on dev machine. [.mcp.json:3-8] *(iter10)*
- **L147**: Self-authenticated path exemption uses `startsWith` prefix match — any future route under `/api/cron/notifications` or `/api/upbank/webhook` prefix inherits auth bypass. [middleware.ts:84-91] *(iter10)*
- **L148**: Decrypted BYOK API key held in closure for entire streaming response duration — plaintext key captured in closure when creating AI provider client. Key remains in memory for 30+ seconds during multi-tool streaming. Cannot be garbage collected until stream completes. [ai/chat/route.ts:76,91-98] *(iter11)*
- **L149**: `fetchTransaction` and `fetchAccount` responses not schema-validated — `response.json()` returned directly with TypeScript type annotation only. No runtime validation. API response shape change (type, null, missing fields) processed silently. `valueInBaseUnits` could be string instead of number. [webhook/route.ts:202-226,173-197] *(iter11)*
- **L150**: Out-of-order SETTLED before CREATED regresses transaction to HELD permanently — SETTLED arrives first, upserts as SETTLED. CREATED arrives later, updates status back to "HELD" and clears `settled_at`. Transaction stuck in HELD status. No second SETTLED event will arrive. [webhook/route.ts:719-771] *(iter11)*
- **L151**: `cashback_description` from UP Bank stored without sanitization — free-text field from cashback partners, separate from merchant-controlled `description`. Additional prompt injection surface for AI categorization. Extends M32/M33. [webhook/route.ts:528] *(iter11)*
- **L152**: Transfer account balance update uses wrong user's partnership for net worth — `updateAccountBalance` for transfer destination called with webhook registrant's `userId`, not transfer account owner's. Net worth snapshot computed for wrong partnership. [webhook/route.ts:437-439,311-315] *(iter11)*
- **L153**: Stale tags never removed on SETTLED event — tag processing only adds/upserts, never deletes. Tags present during HELD but removed by user before settlement persist in `transaction_tags`. Tags accumulate over time. [webhook/route.ts:554-571] *(iter11)*
- **L154**: `convertToTargetPeriod` double-rounding causes cumulative precision loss — converts to monthly intermediate, then to target. Two-step rounding produces systematically different results from direct conversion (e.g., quarterly-to-weekly: 333→111→28 vs direct 333/13→26). [budget-engine.ts:254-296] *(iter11)*
- **L155**: `duplicateBudget` narrow FK race on deleted goals/assets — assignments copied including `goal_id`/`asset_id` FKs. Goal deleted between SELECT and INSERT causes FK violation. Error caught and swallowed, entire duplication fails silently. [budgets.ts:521-543] *(iter11)*
- **L156**: `budget_category_shares.share_percentage` is INTEGER but Zod accepts floats — `z.number().min(0).max(100)` accepts 33.33, PostgreSQL truncates to 33. Silent precision loss affects budget split calculations. [shares/categories/route.ts:77, initial_schema.sql:527] *(iter11)*
- **L157**: `checkAndCreateMilestoneNotification` division by zero when `targetAmountCents` is 0 — `(oldAmountCents / 0) * 100` produces Infinity/NaN. Caught by outer try-catch but creates silent notification failures. Triggered by M216. [goals.ts:25-26] *(iter11)*
- **L158**: Goal new page allows `target_amount_cents: 0` or negative via bypassed HTML validation — `Math.round(parseFloat(targetAmount) * 100)` with no server-side check. HTML `min="0"` and `type="number"` trivially bypassed. [goals/new/page.tsx:96-110] *(iter11)*
- **L159**: `preparation_checklist` stored as unvalidated JSONB — `updateGoal` accepts arbitrary array of `{ item: string; done: boolean }`. No validation on item count, string length, or object shape. Megabytes of data storable in single field. [goals.ts:272,303] *(iter11)*
- **L160**: Toast messages render interpolated error messages without truncation — `toast.error(data.error || "...")` in expense-from-transaction, notification-bell, budget-create-wizard. If server error sanitization fails, raw schema details rendered in UI. [expense-from-transaction.tsx:241, notification-bell.tsx:144, +2] *(iter11)*
- **L161**: `budget-page-shell.tsx` uses `window.history.replaceState` bypassing Next.js router — tab changes update URL directly. Middleware navigation guards and route interception don't fire. Fragile pattern if copied to security-sensitive navigation. [budget-page-shell.tsx:529] *(iter11)*
- **L162**: UP Bank API token input in onboarding missing `autocomplete="off"` — browser may save API token as password credential. Settings version includes hidden email field for password manager context but onboarding version does not. Extends L117. [bank-step.tsx:159-164] *(iter11)*
- **L163**: localStorage keys include partnership UUID — `Object.keys(localStorage).filter(key => key.includes(partnershipId))`. Partnership UUIDs stored as key names. Any XSS or malicious third-party script can enumerate and extract partnership UUIDs (primary authorization pivot per C3). [budget-overview-tab.tsx:291-293] *(iter11)*
- **L164**: Dev tools `dynamic()` import in production settings has no environment guard — webpack chunk exists in production build. `process.env.NODE_ENV === 'development'` conditional in JSX but chunk downloadable. Sync trigger and webhook management UI accessible if check bypassed. Extends I27. [settings/up-connection/page.tsx:30-33] *(iter11)*
- **L165**: Notification bell polling continues regardless of page visibility — `setInterval(fetchNotifications, 30000)` runs without `Page Visibility API` check. Backgrounded tabs continue polling. Multiple tabs generate unnecessary server load. [notification-bell.tsx:83-87] *(iter11)*
- **L166**: `searchParams.toString()` preserves unexpected query parameters across navigation — components read all params, set one, and navigate with full params preserved. Crafted URL `/invest?period=3M&evil=payload` carries `evil` through period-change navigations. URL parameter injection persistent across interactions. [invest-client.tsx:303, invest-detail-client.tsx:106, +2 files] *(iter11)*
- **L167**: `performing_customer` displayName from UP Bank stored without length constraint — unbounded `text` column stored directly from API response. Extremely long display names from corrupted response persist and render without truncation. [webhook/route.ts:539] *(iter11)*
- **L168**: Expense match can "claim" any transaction — POST verifies expense partnership but not transaction ownership. `expense_matches` UNIQUE(transaction_id) means matching to another user's transaction prevents them from matching it. Extends M17. [expenses/match/route.ts:14-100] *(iter11)*
- **L169**: Budget columns API accepts any partnership_id — GET/POST check `userId !== user.id` but not partnership membership. Column configurations could be created in foreign partnerships. Extends M38. [budget/columns/route.ts:11-35,67] *(iter11)*

### INFO (66)

- **I1**: No XML parsing — XXE not applicable
- **I2**: No dangerouslySetInnerHTML or innerHTML usage found
- **I3**: Supabase auth error messages displayed directly to users on login [login/page.tsx:46]
- **I4**: selfAuthenticatedPaths uses startsWith — hypothetical paths could bypass auth [middleware.ts:80]
- **I5**: No CORS issues — same-origin enforcement by default
- **I6**: CSP connect-src allows direct AI provider API connections (may be unnecessary) [next.config.ts:24]
- **I7**: GEMINI_API_KEY in .env.local but not referenced in code (stale secret) [.env.local:10]
- **I8**: ALPHA_VANTAGE_API_KEY in .env.local but service removed (stale secret) [.env.local:2]
- **I9**: Vercel cron job active despite memory note saying "CRON_SECRET removed entirely" [vercel.json:5]
- **I10**: pnpm.overrides configured for 6 known CVEs (positive finding) [package.json:71]
- **I11**: Transaction notes returned to client include is_partner_visible field — filtering is client-side [transactions/route.ts:98]
- **I12**: Sync endpoint has unbounded pagination loop with Up Bank API [upbank/sync/route.ts:218]
- **I13**: No pnpm audit or dependency scanning in CI/CD scripts [package.json:15]
- **I14**: AI API keys sent to third-party AI providers in plaintext (by design — BYOK model) [ai/chat/route.ts:90]
- **I15**: No CSRF token validation — relies on SameSite cookies and JSON content-type [all mutation routes]
- **I16**: Dead code: `queryFinancialData` strips `ai_api_key` from profiles results but `profiles` table removed from ALLOWED_TABLES — unreachable. [ai-tools.ts:1362] *(iter2)*
- **I17**: Inconsistent POST body handling — some routes use `parseBody()` + Zod, others use raw `request.json()`. [multiple routes] *(iter2)*
- **I18**: Partnership ID validation inconsistent — some GET routes validate as UUID via Zod, others accept raw strings. [multiple budget routes] *(iter2)*
- **I19**: `queryFinancialData` `not.in` operator uses manual string construction while `in` uses parameterized `.in()` — asymmetric handling. [ai-tools.ts:1340] *(iter2)*
- **I20**: AI auto-detect endpoint returns `ai_enhanced: true/false` flag — reveals whether user has AI key configured. [auto-detect/route.ts:137] *(iter2)*
- **I21**: `markTransactionAsIncome` bulk-updates ALL transactions matching description across all accounts — no count limit or confirmation. [transactions.ts:52] *(iter2)*
- **I22**: `categories` table has duplicate INSERT RLS policies (permissive + auth-required) — permissive one makes auth check redundant. [initial_schema.sql:1226] *(iter2)*
- **I23**: Weekly summary AI given full write tool access but only needs read — over-privileged tool set for summary generation. [cron/notifications/route.ts:249] *(iter2)*
- **I24**: UP Bank token and AI API keys transiently held in plaintext React state during form input. [bank-step.tsx:18, ai-settings.tsx] *(iter2)*
- **I25**: FIRE `computeSavingsRateCurve` calls `projectFireDate` up to 48 times per request — computational amplification. [fire-gameplan.ts:520] *(iter2)*
- **I26**: AI tool repair fuzzy matching could theoretically be exploited to redirect tool calls to unintended tools via crafted error messages. [ai/chat/route.ts] *(iter3)*
- **I27**: Dev tools conditionally rendered but `dynamic(() => import(...))` creates separate chunk that may exist in production build — admin-level sync triggers and webhook management code potentially downloadable. [budget-overview-tab.tsx:16-18, settings/up-connection/page.tsx:30-33] *(iter3)*
- **I28**: Client-side `useEffect` creates new Supabase client instances via `(await import("@/utils/supabase/client")).createClient()` on every render — multiple auth state listeners and storage subscriptions racing. [transaction-history.tsx:43, transaction-link.tsx:34, budget-page-shell.tsx:414] *(iter3)*
- **I29**: Signup/forgot-password pages use `window.location.origin` fallback for redirect URL — if accessed through proxy or subdomain, redirect could go to unexpected origin. Mitigated by Supabase redirect URL allowlist. [signup/page.tsx:55, forgot-password/page.tsx:40] *(iter3)*
- **I30**: `createExpenseFromTransaction` has TOCTOU race — transaction ownership verified at line 63-71 but expense_match insert at line 157 doesn't re-verify. Transaction could be deleted between check and insert. [expenses.ts:63-169] *(iter4)*
- **I31**: Demo mode auto-login persists session cookies — if demo mode later disabled, existing browser sessions remain valid until expiry. Demo user account remains accessible in now-production system. [middleware.ts:71-82] *(iter4)*
- **I32**: `investment_contributions.amount_cents` is `integer` (32-bit) while all other monetary columns use `bigint` — caps at ~$21.4M. [initial_schema.sql:456] *(iter5)*
- **I33**: `profiles.id` has no explicit FK constraint to `auth.users(id)` in migration — relies on trigger-based creation. Orphan profiles theoretically possible. [initial_schema.sql:205] *(iter5)*
- **I34**: `invalidate_expense_match_on_recategorize` trigger fires on ALL transaction updates, not just category changes. Function has IF guard but trigger overhead on every update (status, description, balance). [initial_schema.sql:1418] *(iter5)*
- **I35**: `get_effective_category_id` SQL function is not SECURITY DEFINER — inherits caller's RLS. Latent risk if ever called from within a SECURITY DEFINER function. [initial_schema.sql:824-833] *(iter5)*
- **I36**: `income_sources.linked_transaction_id` has ON DELETE SET NULL but `income_sources.partnership_id` has ON DELETE CASCADE — asymmetric cascade behavior on same table. [initial_schema.sql:945-946] *(iter5)*
- **I37**: 3 inconsistent authorization patterns across server actions: `getUserPartnershipId()` comparison (budgets, goals), `partnership_members` direct query (partner, expenses), `accounts.user_id` ownership (transactions, income). Weakest path determines security. [all action files] *(iter6)*
- **I38**: Deprecated `interest-cohort=()` in Permissions-Policy — FLoC replaced by Topics API. Policy does not restrict `payment`, `display-capture`, `serial`, `bluetooth`, `usb` APIs. [next.config.ts:10, vercel.json:41] *(iter6)*
- **I39**: Auth confirm OTP type parameter cast `as EmailOtpType` before validation — validation correctly rejects unknown types, but casting order could mask errors. [auth/confirm/route.ts:8] *(iter6)*
- **I40**: No Supabase Realtime subscriptions used in codebase — all data sync via webhooks and API polling. No Realtime-specific RLS concerns apply. Positive finding. *(iter6)*
- **I41**: Error boundaries (`ErrorDisplay` component) do not leak error messages, stack traces, or digests to the UI — shows only generic "Something went wrong" messages. `console.error` in error.tsx files already tracked as M69. Positive finding. [error-display.tsx] *(iter6)*
- **I42**: `get_effective_category_id` SQL function is dead code — not called from any application code or other SQL function. Has no `SET search_path` and references unqualified tables. Should be dropped or secured. [initial_schema.sql:824-833] *(iter7)*
- **I43**: `categories` and `tags` tables are global shared resources — SELECT policies use `USING (true)`. Any authenticated user can see all tag names used by any other user and all categories. Categories INSERT allows any user to create globally-visible categories. [initial_schema.sql:264-275, 1226-1228, 1331-1333] *(iter7)*
- **I44**: `transaction_references.reference_id` UUID column has no FK constraint — references expense_definitions or income_sources by convention only. Corrupted or attacker-crafted reference_id pointing to another user's expense would not be caught by FK validation. [initial_schema.sql:364-370] *(iter7)*
- **I45**: `auditLog()` function in `audit-logger.ts` exists as dead code — defines 5 action types (EXPENSE_DELETED, BUDGET_RESET, PARTNERSHIP_CHANGED, CATEGORY_OVERRIDE, API_KEY_UPDATED) but zero production code paths invoke it. The entire audit infrastructure is built but unused. Deepens M24/L44. [audit-logger.ts] *(iter8)*
- **I46**: Client-exposed `NEXT_PUBLIC_` env vars inventory: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `NEXT_PUBLIC_APP_URL`, `NEXT_PUBLIC_DEMO_MODE`, `NEXT_PUBLIC_SKIP_LANDING` — all intentionally public by design. `NEXT_PUBLIC_SUPABASE_ANON_KEY` is safe because Supabase anon key is designed for client use behind RLS. Positive finding (no secret leakage via NEXT_PUBLIC_ prefix). *(iter9)*
- **I47**: Vercel Analytics and Speed Insights packages (`@vercel/analytics`, `@vercel/speed-insights`) collect performance telemetry — sends page views, Web Vitals, and route-level timing to Vercel servers. No PII collected by default but third-party data flow exists. Privacy policy should mention. [layout.tsx] *(iter9)*
- **I48**: `transaction_share_overrides` POST validates `transaction_id` as UUID via Zod but DB column is `text` — good defense-in-depth but GET/DELETE handlers lack UUID validation, creating read/write asymmetry. [budget/transaction-overrides/route.ts:83,21,165] *(iter10)*
- **I49**: Migration ordering is safe — `00000000000000_initial_schema.sql` runs before `20260226_security_fixes.sql`. Temporal gap depends on deployment timing, not inherent ordering. *(iter10)*
- **I50**: `net_worth_snapshots` has UNIQUE `(partnership_id, snapshot_date)` constraint — M138/M139 TOCTOU race produces constraint error (not duplicate rows). Race still causes incorrect balance but duplicates are DB-prevented. [initial_schema.sql:895] *(iter10)*
- **I51**: Local Supabase `config.toml` disables email confirmations (`enable_confirmations = false`) — appropriate for development but risk if accidentally applied to production. [supabase/config.toml:30] *(iter10)*
- **I52**: Auth callback `allowedHosts` derived from single `NEXT_PUBLIC_APP_URL` — Vercel preview URLs fall through to `request.url` origin fallback. Works correctly but fragile for multi-domain setups. [auth/callback/route.ts:21-29] *(iter10)*
- **I53**: Export blob `URL.createObjectURL` not revoked on error path — `catch` block doesn't call `revokeObjectURL`, leaking blob URL in memory for page lifetime. [export-dialog.tsx:40-53] *(iter10)*
- **I54**: Audit logger `details` field accepts unrestricted `Record<string, unknown>` — no allowlist for sensitive fields. Dead code (I45) but design issue if activated. [audit-logger.ts:32-41] *(iter10)*
- **I55**: Webhook error handler logs raw third-party API error objects — UP Bank and AI provider error responses logged at outer catch. Unlikely to contain tokens but possible. [webhook/route.ts:607,797] *(iter10)*
- **I56**: CSP lacks `upgrade-insecure-requests` and `report-uri`/`report-to` — no mixed content auto-upgrade beyond HSTS and no violation reporting/monitoring. [next.config.ts:18-28] *(iter10)*
- **I57**: `reactStrictMode` not enabled — misses double-invocation checks for effects and deprecated pattern detection during development. [next.config.ts:32-53] *(iter10)*
- **I58**: Single source map file in `.next/static/chunks/` (115KB, likely third-party library) — publicly accessible if served. `productionBrowserSourceMaps` correctly false. [.next/static/chunks/] *(iter10)*
- **I59**: `knip.json` references unpinned external schema URL (`https://unpkg.com/knip@5/schema.json`) — editor intellisense only, not runtime. Minimal supply chain concern. [knip.json:2] *(iter10)*
- **I60**: System prompt visible to BYOK key holder — inherent to BYOK architecture. System prompt contains table schemas and tool descriptions. User can capture full prompt via provider account logging. Not a vulnerability but documents exposure surface. [ai/chat/route.ts:133-231] *(iter11)*
- **I61**: All form inputs use React controlled components — inherently XSS-safe. No `defaultValue` with uncontrolled inputs, no `ref.current.value`, no `dangerouslySetInnerHTML`. React JSX escaping provides built-in XSS protection. Positive finding. *(iter11)*
- **I62**: Recharts Tooltip custom components render data via React JSX — no XSS vector. All `payload` values rendered through JSX escaping (`{entry.name}`, `{formatCurrency(entry.value)}`). No SVG injection possible. Positive finding. *(iter11)*
- **I63**: Clipboard operations limited to non-sensitive data — only 2 clipboard calls: accent picker copies CSS colors, terminal component copies install command. No financial data, tokens, or PII copied. Positive finding. *(iter11)*
- **I64**: No `postMessage`, `addEventListener("message")`, or cross-frame communication patterns — no iframe-based cross-origin communication exists. No cross-frame attack surface. Positive finding. *(iter11)*
- **I65**: FIRE projection loop computational amplification — `runProjection` loops up to 82 iterations per variant × 4 variants. `calculateIncomeMilestones` calls `calculateIncomeImpact` up to 4 times, each calling `projectFireDate`. Up to 1,312 iterations per milestone calculation. Not a DoS vector but worth noting. [fire-calculations.ts:623-672] *(iter11)*
- **I66**: AI chat allows 100 messages × 50KB each = 5MB per request — rate limiter constrains frequency (10/min) but single large request consumes significant server memory during `convertToModelMessages` processing. Inherent to chat architecture. [ai/chat/route.ts:19,23] *(iter11)*

### ATTACK CHAINS (8) — Multi-step attack scenarios combining individual findings *(iter6)*

- **AC1 "Silent Financial Gaslighting"**: Partner unilaterally shifts share percentages (no audit log L34) + hides income via nullable partnership_id (M92) + creates duplicate income sources (M89) + unconstrained share_percentage (M93, L70). Partner B silently responsible for 100% of expenses with no forensic trail. [Combines: L34, L70, M89, M92, M93]
- **AC2 "Budget Phantom Income"**: Manual + auto income source duplication (M89, M72 null collision) inflates TBB. Phantom funds assigned to goals via race condition (M81 read-then-write). False milestone notifications triggered. [Combines: M72, M81, M89]
- **AC3 "Expense Orbit Manipulation"**: Match/unmatch cycle (L59) advances `next_due_date` without rollback. Repeated cycles push due date months/years ahead. Expense vanishes from dashboard and budget views. Recategorize trigger (M94) achieves same effect automatically. [Combines: L59, M75, M94]
- **AC4 "Cron-Powered Cross-User Data Injection" (CRITICAL-severity chain)**: Cron handler creates AI tools with service role (H4, H6). AI write tools unscoped by partnership (H11 updateSavingsGoal, H12 updateInvestment, M34 recategorize). Attacker plants prompt injection in transaction description (H16, M32). Cron AI reads description during weekly summary → executes cross-user writes. Enables modification of ANY user's goals, investments, or transaction categories. [Combines: H4, H5, H6, H11, H12, H16, M32, M33, M34]
- **AC5 "Complete Financial Exfiltration"**: Export endpoint returns full history with no row limit (L17). In-memory rate limiter resets on cold start (M13). No Cache-Control headers (M62). `select("*")` leaks encrypted keys to browser (M54, L26). No audit logging (L44, M24). Complete financial profile extractable in one request with no forensic trail. [Combines: L17, L26, L44, M6, M7, M13, M24, M54, M62]
- **AC6 "SSRF + Phishing Account Takeover"**: Image proxy SSRF (M86) + CSRF origin prefix bypass (M71) + CSRF null origin bypass (M50) + auth callback open redirect via backslash (L53) + password change without re-auth (H9). Chain: phish → open redirect → session hijack → password change → full account takeover. [Combines: H9, L53, M50, M71, M86]
- **AC7 "Thundering Herd DoS"**: backfill-all `Promise.all()` unbounded (M52) + `limit=999999` on transactions (M79) + unbounded summary batches (M29) + no `settled_at` index (L71) + AI context no rate limit (M49) + formula evaluator no depth limit (M53) + notification polling continues under load (M68). Single user can exhaust DB connection pool, affecting all users. [Combines: M13, M29, M49, M52, M53, M68, M76, M79, L71]
- **AC8 "Zombie Partnership"**: Account deletion only removes profile (H10), not auth.users. Partnership data orphaned (H19). No departure mechanism (H20). Webhook persists (M85). New user on same bank account gets duplicate processing. Original user can reset password and access ex-partner's data. merge_partnerships destroys 10+ tables (H22). [Combines: H10, H19, H20, H22, M85]

### DEPENDENCY VULNS (5 remaining after overrides)

- **D1**: minimatch <3.1.3 ReDoS (eslint) [HIGH, dev]
- **D2**: minimatch >=9.0.0 <9.0.6 ReDoS (eslint-config-next) [HIGH, dev]
- **D3**: minimatch >=10.0.0 <10.2.1 ReDoS (shadcn) [HIGH, dev]
- **D4**: lodash <=4.17.22 prototype pollution (recharts) [MEDIUM, prod transitive]
- **D5**: ajv <6.14.0 ReDoS (eslint) [MEDIUM, dev]

## Stats
- Total unique findings: 492 + 5 dep vulns + 8 attack chains = 505
- CRITICAL: 3 | HIGH: 33 | MEDIUM: 221 | LOW: 169 | INFO: 66 | DEP: 5 | CHAINS: 8
- Iterations completed: 11
- Consecutive iterations with no new findings: 0
- Finding velocity: iter1=75, iter2=60, iter3=29, iter4=9, iter5=49, iter6=36, iter7=50, iter8=22, iter9=35, iter10=60, iter11=67
